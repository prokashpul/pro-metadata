<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Enhanced SEO Title -->
    <title>MicroStock Metadata Pro - AI-Powered Stock Photo Metadata Generator for Adobe Stock, Shutterstock & Freepik | Free SEO Tool</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="MicroStock Metadata Pro - AI Stock Photo Metadata Generator">
    <meta name="description" content="Free AI-powered batch metadata generator for stock photographers. Create SEO-optimized titles, descriptions & keywords for Adobe Stock, Shutterstock, and Freepik. Generate up to 25 files simultaneously with Google Gemini AI.">
    <meta name="keywords" content="stock photo metadata generator, Adobe Stock keywords, Shutterstock SEO, Freepik metadata, AI metadata tool, stock photography SEO, batch metadata generator, microstock optimization, stock photo keywords, image SEO tool, contributor tools, stock photo titles, keywording tool, free metadata generator">
    <meta name="author" content="MicroStock Metadata Pro">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    
    <!-- Canonical URL - Update with your actual domain -->
    <link rel="canonical" href="https://yourdomain.com/microstock-metadata-pro">
    
    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/microstock-metadata-pro">
    <meta property="og:title" content="MicroStock Metadata Pro - AI Stock Photo Metadata Generator">
    <meta property="og:description" content="Free AI-powered tool to generate SEO-optimized metadata for Adobe Stock, Shutterstock & Freepik. Batch process up to 25 images with platform-specific optimization.">
    <meta property="og:image" content="https://yourdomain.com/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="MicroStock Metadata Pro">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://yourdomain.com/microstock-metadata-pro">
    <meta name="twitter:title" content="MicroStock Metadata Pro - AI Metadata Generator">
    <meta name="twitter:description" content="Generate SEO-optimized metadata for stock photos using AI. Support for Adobe Stock, Shutterstock & Freepik.">
    <meta name="twitter:image" content="https://yourdomain.com/twitter-card.jpg">
    <meta name="twitter:creator" content="@yourtwitterhandle">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="theme-color" content="#FA0000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MicroStock Metadata">
    <meta name="application-name" content="MicroStock Metadata Pro">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://generativelanguage.googleapis.com">
    
    <!-- Structured Data - JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "MicroStock Metadata Pro",
      "description": "AI-powered batch metadata generation tool for Adobe Stock, Shutterstock, and Freepik. Generate SEO-optimized titles, descriptions, and keywords for stock photography.",
      "url": "https://yourdomain.com/microstock-metadata-pro",
      "applicationCategory": "DesignApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "AI-powered metadata generation",
        "Batch processing up to 25 files",
        "Platform-specific optimization for Adobe Stock, Shutterstock, Freepik",
        "Automatic keyword generation (30-50 keywords per platform)",
        "Title optimization (platform-specific character limits)",
        "CSV and ZIP export",
        "Multi API key pool support",
        "Dark mode interface",
        "Client-side processing for privacy"
      ],
      "screenshot": "https://yourdomain.com/screenshot.jpg",
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "156"
      },
      "author": {
        "@type": "Organization",
        "name": "MicroStock Metadata Pro",
        "url": "https://yourdomain.com"
      },
      "datePublished": "2024-01-01",
      "dateModified": "2025-01-15",
      "browserRequirements": "Requires JavaScript. Requires HTML5.",
      "softwareVersion": "2.2.0",
      "keywords": "stock photo metadata, Adobe Stock, Shutterstock, Freepik, AI metadata generator, SEO optimization, batch processing, microstock tools"
    }
    </script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "MicroStock Metadata Pro",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "reviewCount": "156"
      }
    }
    </script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What is MicroStock Metadata Pro?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "MicroStock Metadata Pro is a free AI-powered tool that generates SEO-optimized metadata for stock photography platforms including Adobe Stock, Shutterstock, and Freepik. It creates platform-specific titles, descriptions, and keywords in batch mode."
          }
        },
        {
          "@type": "Question",
          "name": "Which platforms are supported?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "MicroStock Metadata Pro supports Adobe Stock, Shutterstock, and Freepik with platform-specific optimizations for title length, keyword count, and description requirements."
          }
        },
        {
          "@type": "Question",
          "name": "How many files can I process at once?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "You can process up to 25 files simultaneously in batch mode. The tool supports JPG, PNG, EPS, AI, MOV, and MP4 file formats."
          }
        },
        {
          "@type": "Question",
          "name": "Is my data secure?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes, all processing is done client-side in your browser. Your images and API keys never leave your device, ensuring complete privacy and security."
          }
        }
      ]
    }
    </script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://yourdomain.com"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Tools",
          "item": "https://yourdomain.com/tools"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "MicroStock Metadata Pro",
          "item": "https://yourdomain.com/microstock-metadata-pro"
        }
      ]
    }
    </script>
    
    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --adobe-red: #FA0000;
            --adobe-red-dark: #D60000;
            --shutterstock-blue: #0066CC;
            --freepik-blue: #1273EB;
        }
        
        /* Light Mode Colors */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            padding-top: 4.5rem;
            padding-bottom: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Mode Colors */
        body.dark-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.dark-mode .card {
            background-color: #1e293b;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background-color: var(--adobe-red);
            transition: background-color 0.15s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: var(--adobe-red-dark);
        }
        .btn-primary:active {
            transform: scale(0.99);
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            transition: background-color 0.15s, transform 0.1s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        
        body.dark-mode .btn-secondary {
            background-color: #334155;
            color: #cbd5e1;
        }
        
        body.dark-mode .btn-secondary:hover {
            background-color: #475569;
        }
        
        .file-input-label {
            cursor: pointer;
            border: 3px dashed #cbd5e1;
            text-align: center;
            border-radius: 0.75rem;
            background-color: #fef2f2;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-input-label:hover {
            border-color: var(--adobe-red);
            background-color: #fee2e2;
        }
        
        body.dark-mode .file-input-label {
            background-color: #1e293b;
            border-color: #475569;
        }
        
        body.dark-mode .file-input-label:hover {
            border-color: var(--adobe-red);
            background-color: #334155;
        }
        
        .copy-btn {
            background-color: #f1f5f9;
            transition: background-color 0.1s;
        }
        .copy-btn:hover {
            background-color: #e2e8f0;
        }
        .copy-btn:active {
            transform: scale(0.99);
        }
        
        body.dark-mode .copy-btn {
            background-color: #334155;
        }
        
        body.dark-mode .copy-btn:hover {
            background-color: #475569;
        }
        
        .keyword-pill {
            display: inline-flex;
            padding: 0.3rem 0.75rem;
            margin: 0.25rem;
            background-color: #FA0000;
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .keyword-extra {
             background-color: #3b82f6;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Preview thumbnail size */
        .preview-thumbnail {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body.dark-mode .preview-thumbnail {
            border-color: #475569;
        }
        
        /* Platform badges */
        .platform-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
        }
        
        .platform-adobe {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        
        .platform-shutterstock {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        
        .platform-freepik {
            background-color: #E0E7FF;
            color: #3730A3;
        }
        
        body.dark-mode .platform-adobe {
            background-color: #7F1D1D;
            color: #FEE2E2;
        }
        
        body.dark-mode .platform-shutterstock {
            background-color: #1E3A8A;
            color: #DBEAFE;
        }
        
        body.dark-mode .platform-freepik {
            background-color: #3730A3;
            color: #E0E7FF;
        }
        
        /* Platform checkbox styling */
        .platform-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .platform-checkbox:checked {
            background-color: #6366f1;
            border-color: #6366f1;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        body.dark-mode .platform-checkbox {
            border-color: #475569;
            background-color: #334155;
        }
        
        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        body.dark-mode #main-header {
            background-color: #1e293b;
            border-bottom-color: #334155;
        }
        
        #apiModal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        /* Dark mode for modal backdrop */
        body.dark-mode #apiModal {
            background-color: rgba(0, 0, 0, 0.85);
        }
        
        /* Footer Styles */
        #main-footer {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            margin-top: 4rem;
            transition: background 0.3s ease;
        }
        
        body.dark-mode #main-footer {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        }
        
        .footer-link {
            color: #cbd5e1;
            transition: color 0.2s;
        }
        .footer-link:hover {
            color: var(--adobe-red);
        }
        .tech-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            font-size: 0.75rem;
            margin: 0.25rem;
        }
        
        /* Dark mode toggle button */
        .theme-toggle {
            background-color: #f1f5f9;
            transition: background-color 0.2s;
        }
        
        .theme-toggle:hover {
            background-color: #e2e8f0;
        }
        
        body.dark-mode .theme-toggle {
            background-color: #334155;
        }
        
        body.dark-mode .theme-toggle:hover {
            background-color: #475569;
        }
        
        /* Editable field styles */
        .editable-input,
        .editable-textarea {
            transition: all 0.2s ease;
            background-color: transparent;
        }
        
        .editable-input:focus,
        .editable-textarea:focus {
            outline: none;
            background-color: #f8fafc;
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .editable-input:focus,
        body.dark-mode .editable-textarea:focus {
            background-color: #0f172a;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .edit-indicator {
            font-size: 0.65rem;
            color: #6366f1;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Character count warning styles */
        .char-warning {
            color: #dc2626;
            font-weight: 600;
        }
        
        .char-success {
            color: #16a34a;
            font-weight: 600;
        }
        
        /* Keyword count styles */
        .keyword-count-warning {
            color: #dc2626;
            font-weight: 600;
        }
        
        .keyword-count-success {
            color: #16a34a;
            font-weight: 600;
        }
        
        .keyword-count-info {
            color: #2563eb;
            font-weight: 600;
        }
        
        /* API Key Item Styles */
        .api-key-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        body.dark-mode .api-key-item {
            background-color: #0f172a;
            border-color: #334155;
        }
        
        .api-key-item:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        body.dark-mode .api-key-item:hover {
            background-color: #1e293b;
            border-color: #475569;
        }
        
        .api-key-text {
            flex: 1;
            font-family: monospace;
            font-size: 0.75rem;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        body.dark-mode .api-key-text {
            color: #94a3b8;
        }
        
        .btn-remove-key {
            padding: 0.25rem 0.5rem;
            background-color: #fee2e2;
            color: #991b1b;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-remove-key:hover {
            background-color: #fecaca;
        }
        
        body.dark-mode .btn-remove-key {
            background-color: #7f1d1d;
            color: #fee2e2;
        }
        
        body.dark-mode .btn-remove-key:hover {
            background-color: #991b1b;
        }
        
        .key-pool-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        body.dark-mode .key-pool-badge {
            background-color: #1e3a8a;
            color: #dbeafe;
        }
        
        /* Preview upload button for vector files */
        .preview-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #c7d2fe;
        }
        
        .preview-upload-btn:hover {
            background-color: #c7d2fe;
        }
        
        body.dark-mode .preview-upload-btn {
            background-color: #3730a3;
            color: #e0e7ff;
            border-color: #4338ca;
        }
        
        body.dark-mode .preview-upload-btn:hover {
            background-color: #4338ca;
        }
        
        /* Text color adjustments for dark mode */
        body.dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .text-gray-500 {
            color: #64748b !important;
        }
        
        body.dark-mode .text-gray-400 {
            color: #475569 !important;
        }
        
        /* Border colors for dark mode */
        body.dark-mode .border-gray-200 {
            border-color: #334155 !important;
        }
        
        body.dark-mode .border-gray-300 {
            border-color: #475569 !important;
        }
        
        body.dark-mode .border-gray-700 {
            border-color: #1e293b !important;
        }
        
        /* Background colors for dark mode */
        body.dark-mode .bg-white {
            background-color: #1e293b !important;
        }
        
        body.dark-mode .bg-gray-50 {
            background-color: #334155 !important;
        }
        
        body.dark-mode .bg-gray-100 {
            background-color: #475569 !important;
        }
        
        body.dark-mode .bg-green-50 {
            background-color: #14532d !important;
        }
        
        body.dark-mode .bg-yellow-50 {
            background-color: #422006 !important;
        }
        
        body.dark-mode .bg-red-50 {
            background-color: #450a0a !important;
        }
        
        /* Input fields in dark mode */
        body.dark-mode input[type="text"],
        body.dark-mode input[type="checkbox"],
        body.dark-mode input[type="file"],
        body.dark-mode textarea {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        body.dark-mode input[type="text"]:focus,
        body.dark-mode textarea:focus {
            border-color: #6366f1;
            background-color: #1e293b;
        }
        
        /* Platform tabs */
        .platform-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .platform-tab:hover {
            background-color: #f1f5f9;
        }
        
        .platform-tab.active {
            border-bottom-color: #6366f1;
            font-weight: 600;
        }
        
        body.dark-mode .platform-tab:hover {
            background-color: #334155;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- FIXED HEADER -->
    <header id="main-header" class="p-4" role="banner">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                 <h1 class="text-2xl font-extrabold text-gray-900">
                    <span style="color:var(--adobe-red);">MicroStock</span> Metadata Pro
                </h1>
                
            </div>
            
            <div class="flex items-center space-x-2">
                <!-- Dark Mode Toggle Button -->
                <button onclick="toggleDarkMode()" 
                    class="theme-toggle p-2 rounded-lg transition duration-150" 
                    title="Toggle dark mode"
                    aria-label="Toggle dark mode">
                    <svg id="sunIcon" class="w-5 h-5 text-gray-700 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moonIcon" class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                
                <button onclick="showApiModal()" 
                    class="px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-2"
                    aria-label="Manage API Keys">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.996.608 2.245.54 3.14-.078z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="hidden sm:inline">API Keys</span>
                    <span class="inline sm:hidden">API</span>
                    <span id="keyPoolCount" class="key-pool-badge">0</span>
                </button>
            </div>
        </div>
    </header>

    <main id="app" class="max-w-7xl mx-auto p-4 sm:p-8" role="main">
        
        <!-- Main Application Description -->
        <header class="text-center mb-12">
            <h2 class="text-xl text-gray-600 mt-3">
                Generate platform-optimized metadata for <strong>Adobe Stock</strong>, <strong>Shutterstock</strong>, and <strong>Freepik</strong> simultaneously with AI-powered automation.
            </h2>
            <p class="text-sm text-gray-500 mt-2">
                Free batch metadata generator ‚Ä¢ SEO-optimized titles & keywords ‚Ä¢ Support for 25 files ‚Ä¢ Powered by Google Gemini AI
            </p>
        </header>


        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- UPLOAD AND CONTROLS (Left Column) -->
            <section class="lg:col-span-1 space-y-6" aria-labelledby="upload-heading">
                <article class="card p-6">
                    <h2 id="upload-heading" class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">1. Upload Files</h2>
                    
                    <!-- File Preview Area -->
                    <div id="filePreviewContainer" class="mb-4 w-full h-24 flex flex-col items-center justify-center" aria-live="polite">
                        <svg id="filePlaceholderIcon" class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        <p id="filePreviewText" class="text-gray-600 font-semibold">No files selected.</p>
                    </div>
                    
                    <div class="input-group mb-6">
                        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.ai,.eps,.mp4,.mov" class="hidden" onchange="handleFileChange(this)" multiple aria-label="Upload stock images or videos">
                        <label for="fileInput" class="file-input-label block p-6 sm:p-10">
                            <span class="text-lg font-semibold block mb-1 text-gray-700" id="fileNameDisplay">Click or drag files here (Max 25)</span>
                            <span class="text-sm text-gray-500 block">JPG, PNG, EPS, AI, MOV, MP4 supported.</span>
                        </label>
                    </div>
                    
                    <!-- Platform Selection -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">Select Target Stock Platforms:</h3>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-100 transition">
                                <input type="checkbox" id="platformAdobe" class="platform-checkbox" checked onchange="updatePlatformSelection()" aria-label="Generate metadata for Adobe Stock">
                                <span class="platform-badge platform-adobe">Adobe Stock</span>
                                <span class="text-xs text-gray-500 ml-auto">30-49 keywords | Title: 150-190 chars </span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-100 transition">
                                <input type="checkbox" id="platformShutterstock" class="platform-checkbox" checked onchange="updatePlatformSelection()" aria-label="Generate metadata for Shutterstock">
                                <span class="platform-badge platform-shutterstock">Shutterstock</span>
                                <span class="text-xs text-gray-500 ml-auto">30-50 keywords | Title: 145-200 chars </span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-100 transition">
                                <input type="checkbox" id="platformFreepik" class="platform-checkbox" checked onchange="updatePlatformSelection()" aria-label="Generate metadata for Freepik">
                                <span class="platform-badge platform-freepik">Freepik</span>
                                <span class="text-xs text-gray-500 ml-auto">30-50 keywords | Title: 75-100 chars</span>
                            </label>
                        </div>
                        <p id="platformWarning" class="text-xs text-amber-600 mt-2 hidden" role="alert">‚ö†Ô∏è Please select at least one platform</p>
                    </div>

                    <div class="space-y-3">
                        <button id="analyzeBtn" onclick="generateMetadata()" 
                            class="btn-primary w-full text-white py-3 rounded-lg font-bold flex items-center justify-center disabled:opacity-50" 
                            disabled
                            aria-label="Generate AI-powered metadata for selected files">
                            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="analyzeText">Generate Metadata for Batch</span>
                        </button>
                        
                        <button id="clearBtn" onclick="clearAll()" 
                            class="btn-secondary w-full py-3 rounded-lg font-bold flex items-center justify-center disabled:opacity-50" 
                            disabled
                            aria-label="Clear all uploaded files and results">
                            Clear All Files & Results
                        </button>
                        
                    </div>
                    <p id="analysisMethod" class="text-xs text-center text-gray-500 mt-3" aria-live="polite"></p>
                </article>
            </section>

            <!-- METADATA OUTPUT (Right Columns) -->
            <section class="lg:col-span-2 space-y-6" aria-labelledby="results-heading">
                <article class="card p-6">
                    <h2 id="results-heading" class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">2. Generated Metadata (<span id="resultsCount">0</span> Files)</h2>
                    
                    <!-- Grouped Download Buttons -->
                    <div class="flex flex-wrap gap-2 mb-4"> 
                        <button id="downloadZipAdobe" onclick="createZipAndDownload('adobe')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-white rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center justify-center" 
                            style="background-color: var(--adobe-red);" 
                            disabled
                            aria-label="Download Adobe Stock ZIP with renamed files">
                            üì¶ Adobe Stock ZIP
                        </button>
                        
                        <button id="downloadZipShutterstock" onclick="createZipAndDownload('shutterstock')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-white rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center justify-center" 
                            style="background-color: var(--shutterstock-blue);" 
                            disabled
                            aria-label="Download Shutterstock ZIP with renamed files">
                            üì¶ Shutterstock ZIP
                        </button>
                        
                        <button id="downloadZipFreepik" onclick="createZipAndDownload('freepik')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-white rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center justify-center" 
                            style="background-color: var(--freepik-blue);" 
                            disabled
                            aria-label="Download Freepik ZIP with renamed files">
                            üì¶ Freepik ZIP
                        </button>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <button id="downloadCsvAll" onclick="downloadCsv('all')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-gray-800 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50" 
                            disabled
                            aria-label="Download metadata as CSV spreadsheet for all platforms">
                            üìä Download All CSVs
                        </button>
                    </div>
                    
                    <!-- Container for all results -->
                    <div id="resultsContainer" class="space-y-4" role="list" aria-label="Generated metadata results">
                        <p id="initialOutputPlaceholder" class="text-gray-400 italic">Upload and analyze files to see AI-generated stock photo metadata here.</p>
                        <!-- Dynamic file results will be inserted here -->
                    </div>
                </article>
            </section>
        </div>
        
        <!-- Status Message Box -->
        <div id="statusMessage" class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50" role="alert" aria-live="assertive">
            <!-- Messages appear here -->
        </div>

    </main>
    
    <!-- FOOTER SECTION -->
    <footer id="main-footer" class="mt-16 py-8 border-t border-gray-700" role="contentinfo">
        <div class="max-w-7xl mx-auto px-4 sm:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                
                <!-- Column 1: Branding & Description -->
                <div class="space-y-3">
                    <h3 class="text-lg font-bold text-white">
                        <span style="color:var(--adobe-red);">MicroStock</span> Metadata Pro
                    </h3>
                    <p class="text-sm text-gray-400">
                        AI-powered batch metadata generation tool for <strong>Adobe Stock</strong>, <strong>Shutterstock</strong>, and <strong>Freepik</strong>. Platform-specific optimization with intelligent SEO suggestions for stock photographers and contributors.
                    </p>
                    <p class="text-xs text-gray-500">
                        Version 2.2.0 | Updated January 2025
                    </p>
                </div>

                <!-- Column 2: Tech Stack -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider">Powered By</h4>
                    <div class="flex flex-wrap">
                        <span class="tech-badge">ü§ñ Google Gemini 2.0</span>
                        <span class="tech-badge">‚ö° Tailwind CSS</span>
                        <span class="tech-badge">üì¶ JSZip</span>
                        <span class="tech-badge">üé® Inter Font</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Built with cutting-edge AI and modern web technologies for professional stock photographers.
                    </p>
                </div>

                <!-- Column 3: Links & Info -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider">Supported Stock Platforms</h4>
                    <ul class="space-y-2 text-sm">
                        <li>
                            <a href="https://contributor.stock.adobe.com/" target="_blank" rel="noopener noreferrer" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Adobe Stock Contributor</span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.shutterstock.com/contributor" target="_blank" rel="noopener noreferrer" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Shutterstock Contributor</span>
                            </a>
                        </li>
                        <li>
                            <a href="https://contributor.freepik.com" target="_blank" rel="noopener noreferrer" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Freepik Contributor</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="pt-6 border-t border-gray-700 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <p class="text-xs text-gray-500">
                    ¬© 2025 <span style="color:var(--adobe-red);">MicroStock</span> Metadata Pro. Not officially affiliated with Adobe, Shutterstock, or Freepik.
                </p>
                <div class="flex items-center space-x-4 text-xs text-gray-500">
                    <span class="flex items-center space-x-1">
                        <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span>Client-side Processing</span>
                    </span>
                    <span class="flex items-center space-x-1">
                        <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                        <span>Privacy Focused</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- API KEY MODAL -->
    <div id="apiModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 invisible opacity-0" role="dialog" aria-labelledby="apiModalTitle" aria-modal="true">
        <div class="card w-full max-w-2xl p-6 sm:p-8 transform transition-all duration-300 scale-95 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="apiModalTitle" class="text-2xl font-bold text-gray-900">API Key Pool Management</h3>
                <button onclick="hideApiModal()" class="text-gray-400 hover:text-gray-600" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start space-x-2">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div class="text-sm text-blue-800">
                        <p class="font-semibold mb-1">Multi-Key Pool Benefits:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>Distribute API load across multiple keys</li>
                            <li>Avoid rate limiting with automatic rotation</li>
                            <li>Fallback protection if one key fails</li>
                            <li>Keys are stored securely in your browser</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Add New Key Section -->
            <div class="mb-6">
                <h4 class="text-sm font-bold text-gray-700 mb-3">Add New Gemini API Key</h4>
                <div class="flex gap-2">
                    <input type="text" 
                        id="newApiKeyInput" 
                        placeholder="AIzaSy..." 
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                        aria-label="Enter new Google Gemini API key">
                    <button onclick="addApiKey()" 
                        class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-1"
                        aria-label="Add API key to pool">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Add Key</span>
                    </button>
                </div>
            </div>

            <!-- API Key List -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-sm font-bold text-gray-700">Your API Keys (<span id="modalKeyCount">0</span>)</h4>
                    <button onclick="clearAllKeys()" 
                        class="text-xs text-red-600 hover:text-red-700 font-semibold flex items-center space-x-1"
                        aria-label="Remove all API keys">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span>Clear All</span>
                    </button>
                </div>
                
                <div id="apiKeyList" class="space-y-2 max-h-64 overflow-y-auto" role="list" aria-label="API key list">
                    <p class="text-sm text-gray-400 italic text-center py-4">No API keys added yet.</p>
                </div>
            </div>
            
            <div id="apiStatusMessage" class="mt-4 text-xs font-medium text-center text-indigo-600" aria-live="polite">
                <!-- Status messages appear here -->
            </div>

            <div class="mt-6 flex justify-between items-center pt-4 border-t">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" 
                    class="text-xs text-indigo-600 hover:text-indigo-700 font-semibold flex items-center space-x-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    <span>Get Free API Key from Google</span>
                </a>
                <button type="button" onclick="hideApiModal()" 
                    class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">
                    Done
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Dark Mode Functionality ---
        const DARK_MODE_STORAGE = 'multiPlatformStock_darkMode';
        
        function initDarkMode() {
            const savedDarkMode = localStorage.getItem(DARK_MODE_STORAGE);
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                updateDarkModeIcons(true);
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem(DARK_MODE_STORAGE, isDark);
            updateDarkModeIcons(isDark);
        }
        
        function updateDarkModeIcons(isDark) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (isDark) {
                sunIcon.classList.remove('hidden');
                sunIcon.classList.add('text-gray-300');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                moonIcon.classList.add('text-gray-700');
            }
        }
        
        // Initialize dark mode on page load
        initDarkMode();
        
        // --- Platform Configuration ---
        const PLATFORM_CONFIGS = {
            adobe: {
                name: 'Adobe Stock',
                titleMax: 190,
                titleMin: 150,
                descMax: 200,
                keywordsMin: 30,
                keywordsMax: 49,
                systemPrompt: `You are a world-class Adobe Stock SEO expert. Generate metadata optimized for Adobe Stock's algorithm with these STRICT RULES:

TITLE REQUIREMENTS (CRITICAL):
- Must be EXACTLY 150-190 characters (strictly enforce)
- Use Title Case (First Letter Capitalized)
- ABSOLUTELY NO symbols, icons, emojis, or special characters (only letters, numbers, spaces, hyphens)
- NO negative words (avoid: without, no, lack, missing, empty, etc.)
- Must be highly descriptive and SEO-friendly
- Only describe what IS in the image, not what isn't
- Use specific, searchable terms

DESCRIPTION REQUIREMENTS:
- Maximum 200 characters
- Engaging and informative
- NO negative language
- Focus on positive attributes and features

KEYWORDS REQUIREMENTS (CRITICAL):
- Generate EXACTLY 30-49 unique keywords (MINIMUM 30 REQUIRED)
- All lowercase
- Only relevant to actual file content
- NO negative words
- Mix of specific and broad terms
- Highly searchable and commercially relevant
- No duplicates`
            },
            shutterstock: {
                name: 'Shutterstock',
                titleMax: 200,
                titleMin: 145,
                descMax: 200,
                keywordsMin: 30,
                keywordsMax: 50,
                systemPrompt: `You are a Shutterstock SEO specialist. Generate metadata optimized for Shutterstock's search algorithm with these STRICT RULES:

TITLE REQUIREMENTS (CRITICAL):
- Must be EXACTLY 145-200 characters (strictly enforce)
- Use Title Case (First Letter Capitalized)
- ABSOLUTELY NO symbols, icons, emojis, or special characters (only letters, numbers, spaces, hyphens)
- NO negative words (avoid: without, no, lack, missing, empty, etc.)
- Must be highly descriptive and SEO-friendly
- Only describe what IS in the image, not what isn't
- Use specific, searchable terms

DESCRIPTION REQUIREMENTS:
- Maximum 200 characters
- Detailed and informative
- NO negative language
- Focus on positive features and applications

KEYWORDS REQUIREMENTS (CRITICAL):
- Generate EXACTLY 30-50 unique keywords (MINIMUM 30 REQUIRED)
- All lowercase
- Only relevant to actual file content
- NO negative words
- Mix of specific, broad, and niche terms
- Highly searchable and commercially relevant
- No duplicates`
            },
            freepik: {
                name: 'Freepik',
                titleMax: 100,
                titleMin: 75,
                descMax: 200,
                keywordsMin: 30,
                keywordsMax: 50,
                systemPrompt: `You are a Freepik content optimization expert. Generate metadata for Freepik's platform with these STRICT RULES:

TITLE REQUIREMENTS (CRITICAL):
- Must be EXACTLY 75-100 characters (strictly enforce)
- Use Title Case (First Letter Capitalized)
- ABSOLUTELY NO symbols, icons, emojis, or special characters (only letters, numbers, spaces, hyphens)
- NO negative words (avoid: without, no, lack, missing, empty, etc.)
- Must be concise, descriptive, and SEO-friendly
- Only describe what IS in the image, not what isn't
- Use specific, searchable terms

DESCRIPTION REQUIREMENTS:
- Maximum 200 characters
- Informative and appealing
- NO negative language
- Focus on style, theme, and usage

KEYWORDS REQUIREMENTS (CRITICAL):
- Generate EXACTLY 30-50 unique keywords (MINIMUM 30 REQUIRED)
- All lowercase
- Only relevant to actual file content
- NO negative words
- Focus on style, theme, colors, and usage
- Highly searchable and commercially relevant
- No duplicates`
            }
        };
        
        // --- API Key Pool Management ---
        const API_KEY_POOL_STORAGE = 'multiPlatformStock_apiKeyPool';
        
        const state = {
            files: [],
            results: [],
            maxFiles: 25,
            apiKeyPool: [],
            currentKeyIndex: 0,
            selectedPlatforms: ['adobe', 'shutterstock', 'freepik']
        };
        
        // Load API keys from localStorage
        function loadApiKeyPool() {
            try {
                const saved = localStorage.getItem(API_KEY_POOL_STORAGE);
                if (saved) {
                    state.apiKeyPool = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load API key pool:', e);
                state.apiKeyPool = [];
            }
            updateKeyPoolDisplay();
        }
        
        // Save API keys to localStorage
        function saveApiKeyPool() {
            try {
                localStorage.setItem(API_KEY_POOL_STORAGE, JSON.stringify(state.apiKeyPool));
                updateKeyPoolDisplay();
            } catch (e) {
                console.error('Failed to save API key pool:', e);
                showStatus('Failed to save API keys', 'error');
            }
        }
        
        // Get next API key from pool (round-robin)
        function getNextApiKey() {
            if (state.apiKeyPool.length === 0) {
                throw new Error('No API keys configured. Please add at least one API key.');
            }
            
            const key = state.apiKeyPool[state.currentKeyIndex];
            state.currentKeyIndex = (state.currentKeyIndex + 1) % state.apiKeyPool.length;
            
            return key;
        }
        
        // Add new API key to pool
        window.addApiKey = function() {
            const input = document.getElementById('newApiKeyInput');
            const newKey = input.value.trim();
            
            if (!newKey) {
                showApiStatus('Please enter an API key', 'error');
                return;
            }
            
            if (newKey.length < 20) {
                showApiStatus('API key looks too short. Please check it.', 'error');
                return;
            }
            
            if (state.apiKeyPool.includes(newKey)) {
                showApiStatus('This key is already in your pool', 'error');
                return;
            }
            
            state.apiKeyPool.push(newKey);
            saveApiKeyPool();
            renderApiKeyList();
            
            input.value = '';
            showApiStatus(`Key added! Pool now has ${state.apiKeyPool.length} key(s)`, 'success');
        }
        
        // Remove API key from pool
        window.removeApiKey = function(index) {
            if (confirm('Remove this API key from the pool?')) {
                state.apiKeyPool.splice(index, 1);
                saveApiKeyPool();
                renderApiKeyList();
                showApiStatus('Key removed from pool', 'success');
            }
        }
        
        // Clear all API keys
        window.clearAllKeys = function() {
            if (confirm(`Remove all ${state.apiKeyPool.length} API keys from the pool?`)) {
                state.apiKeyPool = [];
                saveApiKeyPool();
                renderApiKeyList();
                showApiStatus('All keys cleared', 'success');
            }
        }
        
        // Render API key list in modal
        function renderApiKeyList() {
            const container = document.getElementById('apiKeyList');
            const countEl = document.getElementById('modalKeyCount');
            
            countEl.textContent = state.apiKeyPool.length;
            
            if (state.apiKeyPool.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 italic text-center py-4">No API keys added yet.</p>';
                return;
            }
            
            container.innerHTML = state.apiKeyPool.map((key, index) => {
                const maskedKey = `${key.substring(0, 12)}...${key.substring(key.length - 4)}`;
                return `
                    <div class="api-key-item" role="listitem">
                        <span class="text-xs font-semibold text-gray-500">#${index + 1}</span>
                        <span class="api-key-text">${maskedKey}</span>
                        <button onclick="removeApiKey(${index})" class="btn-remove-key" aria-label="Remove API key ${index + 1}">
                            Remove
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Update key pool count badge
        function updateKeyPoolDisplay() {
            const badge = document.getElementById('keyPoolCount');
            badge.textContent = state.apiKeyPool.length;
            
            if (state.apiKeyPool.length === 0) {
                badge.classList.add('bg-red-100', 'text-red-800');
                badge.classList.remove('bg-blue-100', 'text-blue-800');
            } else {
                badge.classList.add('bg-blue-100', 'text-blue-800');
                badge.classList.remove('bg-red-100', 'text-red-800');
            }
        }
        
        // Show status in modal
        function showApiStatus(message, type) {
            const statusEl = document.getElementById('apiStatusMessage');
            statusEl.textContent = message;
            statusEl.className = 'mt-4 text-xs font-medium text-center';
            
            if (type === 'success') {
                statusEl.classList.add('text-green-600');
            } else if (type === 'error') {
                statusEl.classList.add('text-red-600');
            } else {
                statusEl.classList.add('text-indigo-600');
            }
            
            setTimeout(() => {
                statusEl.textContent = '';
            }, 3000);
        }
        
        // --- Core Application Logic ---
        const MAX_RETRIES = 2;

        const elements = {
            fileInput: document.getElementById('fileInput'),
            fileNameDisplay: document.getElementById('fileNameDisplay'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            spinner: document.getElementById('spinner'),
            analyzeText: document.getElementById('analyzeText'),
            statusMessage: document.getElementById('statusMessage'),
            filePreviewContainer: document.getElementById('filePreviewContainer'),
            filePlaceholderIcon: document.getElementById('filePlaceholderIcon'),
            filePreviewText: document.getElementById('filePreviewText'),
            analysisMethod: document.getElementById('analysisMethod'),
            resultsContainer: document.getElementById('resultsContainer'),
            initialOutputPlaceholder: document.getElementById('initialOutputPlaceholder'),
            resultsCount: document.getElementById('resultsCount'),
            clearBtn: document.getElementById('clearBtn'), 
            apiModal: document.getElementById('apiModal'),
            apiStatusMessage: document.getElementById('apiStatusMessage'),
        };

        // --- Editable Field Functions ---
        
        window.updateMetadata = function(id, platform, field, value) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem && resultItem.platformMetadata[platform]) {
                if (field === 'keywords') {
                    const keywords = value.split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
                    resultItem.platformMetadata[platform].keywords = [...new Set(keywords)];
                    updateKeywordCount(id, platform);
                } else {
                    resultItem.platformMetadata[platform][field] = value;
                }
                
                if (field === 'title') {
                    updateCharacterCount(id, platform);
                }
            }
        }
        
        function updateCharacterCount(id, platform) {
            const config = PLATFORM_CONFIGS[platform];
            const inputElement = document.getElementById(`title-input-${id}-${platform}`);
            const charCountElement = document.getElementById(`char-count-${id}-${platform}`);
            
            if (inputElement && charCountElement) {
                const length = inputElement.value.length;
                const isValid = length >= config.titleMin && length <= config.titleMax;
                
                charCountElement.textContent = `${length}/${config.titleMax} characters (Required: ${config.titleMin}-${config.titleMax})`;
                
                if (isValid) {
                    charCountElement.classList.remove('char-warning');
                    charCountElement.classList.add('char-success');
                } else {
                    charCountElement.classList.remove('char-success');
                    charCountElement.classList.add('char-warning');
                }
            }
        }
        
        // Update keyword count
        function updateKeywordCount(id, platform) {
            const config = PLATFORM_CONFIGS[platform];
            const countElement = document.getElementById(`keyword-count-${id}-${platform}`);
            const resultItem = state.results.find(r => r.id === id);
            
            if (countElement && resultItem && resultItem.platformMetadata[platform]) {
                const count = resultItem.platformMetadata[platform].keywords.length;
                const isValid = count >= config.keywordsMin && count <= config.keywordsMax;
                const isBelowMin = count < config.keywordsMin;
                
                countElement.textContent = `${count}/${config.keywordsMax} keywords (Min: ${config.keywordsMin})`;
                
                // Remove all classes first
                countElement.classList.remove('keyword-count-warning', 'keyword-count-success', 'keyword-count-info');
                
                if (isBelowMin) {
                    countElement.classList.add('keyword-count-warning');
                } else if (isValid) {
                    countElement.classList.add('keyword-count-success');
                } else {
                    countElement.classList.add('keyword-count-info');
                }
            }
        }

        // --- Preview Image Upload for Vector Files ---
        window.uploadPreviewImage = function(id) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.jpg,.jpeg,.png';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const dataUrl = await fileToDataUrl(file);
                        const resultItem = state.results.find(r => r.id === id);
                        if (resultItem) {
                            resultItem.thumbnail = dataUrl;
                            resultItem.previewFile = file;
                            renderOutput();
                            showStatus('Preview image uploaded successfully!', 'success');
                        }
                    } catch (error) {
                        showStatus('Failed to upload preview image', 'error');
                    }
                }
            };
            input.click();
        }

        // --- API Modal Functions ---
        window.showApiModal = function() {
            renderApiKeyList();
            elements.apiModal.classList.remove('invisible', 'opacity-0');
            elements.apiModal.classList.add('opacity-100');
        }

        window.hideApiModal = function() {
            elements.apiModal.classList.remove('opacity-100');
            elements.apiModal.classList.add('invisible', 'opacity-0');
        }

        // --- Utility Functions ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function getFileIcon(extension) {
            const defaultColor = '#5e5e5e'; 
            let svgPath = '';

            if (extension === 'video' || extension === 'mp4' || extension === 'mov') {
                svgPath = `<path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 10h7a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2a1 1 0 011-1z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else if (extension === 'ai' || extension === 'eps') {
                svgPath = `<path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 12h6M9 16h6M9 8h1" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round"/>`;
            } else {
                svgPath = `<path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13 2v7h7" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            }

            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 24 24" fill="none" stroke="currentColor">${svgPath}</svg>`;
            return `data:image/svg+xml;base64,${btoa(svg)}`;
        }
        
        async function getThumbnailData(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png'].includes(extension);
            const isVideo = ['mp4', 'mov'].includes(extension);
            const isVector = ['ai', 'eps'].includes(extension);

            if (isImage) {
                return fileToDataUrl(file);
            } else if (isVideo) {
                return getFileIcon('video');
            } else if (isVector) {
                return getFileIcon(extension);
            } else {
                return getFileIcon('generic');
            }
        }

        function clearPreview() {
            state.files = [];
            state.results = [];

            elements.filePlaceholderIcon.classList.remove('hidden');
            elements.filePlaceholderIcon.innerHTML = `<svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`;
            elements.filePreviewText.textContent = 'No files selected.';

            elements.analyzeText.textContent = 'Generate Metadata for Batch';
            
            renderOutput();
        }

        // --- Platform Selection ---
        window.updatePlatformSelection = function() {
            const adobe = document.getElementById('platformAdobe').checked;
            const shutterstock = document.getElementById('platformShutterstock').checked;
            const freepik = document.getElementById('platformFreepik').checked;
            
            state.selectedPlatforms = [];
            if (adobe) state.selectedPlatforms.push('adobe');
            if (shutterstock) state.selectedPlatforms.push('shutterstock');
            if (freepik) state.selectedPlatforms.push('freepik');
            
            const warning = document.getElementById('platformWarning');
            if (state.selectedPlatforms.length === 0) {
                warning.classList.remove('hidden');
                document.getElementById('analyzeBtn').disabled = true;
            } else {
                warning.classList.add('hidden');
                if (state.files.length > 0 && state.apiKeyPool.length > 0) {
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }
            
            updateDownloadButtons();
        }
        
        function updateDownloadButtons() {
            const completedCount = state.results.filter(r => r.status === 'complete').length;
            
            document.getElementById('downloadZipAdobe').disabled = !state.selectedPlatforms.includes('adobe') || completedCount === 0;
            document.getElementById('downloadZipShutterstock').disabled = !state.selectedPlatforms.includes('shutterstock') || completedCount === 0;
            document.getElementById('downloadZipFreepik').disabled = !state.selectedPlatforms.includes('freepik') || completedCount === 0;
            document.getElementById('downloadCsvAll').disabled = completedCount === 0;
        }

        window.handleFileChange = async function(input) {
            if (input.files.length === 0) {
                elements.fileNameDisplay.textContent = 'Click or drag files here (Max 25)';
                elements.analyzeBtn.disabled = true;
                elements.clearBtn.disabled = true;
                elements.analysisMethod.textContent = '';
                clearPreview();
                return;
            }
            
            const selectedFiles = Array.from(input.files).slice(0, state.maxFiles);
            state.files = selectedFiles;
            
            const filePromises = selectedFiles.map(async (file) => ({
                file,
                status: 'pending',
                platformMetadata: {},
                id: crypto.randomUUID(),
                thumbnail: await getThumbnailData(file),
                activePlatform: state.selectedPlatforms[0] || 'adobe',
                previewFile: null
            }));

            state.results = await Promise.all(filePromises);

            elements.fileNameDisplay.textContent = `${state.files.length} file(s) selected.`;
            elements.filePreviewText.textContent = `Ready to process ${state.files.length} file(s).`;
            elements.analyzeBtn.disabled = state.selectedPlatforms.length === 0 || state.apiKeyPool.length === 0;
            elements.clearBtn.disabled = false;
            elements.analysisMethod.textContent = `Batch mode for ${state.selectedPlatforms.length} platform(s). Processing ${state.files.length} file(s). Using ${state.apiKeyPool.length} API key(s).`;

            renderOutput();
        }

        async function callGeminiApiWithBackoff(payload, attempt = 0) {
            try {
                const currentKey = getNextApiKey();
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${currentKey}`;
                
                const delay = Math.pow(2, attempt) * 500 + Math.random() * 300;
                if (attempt > 0) await new Promise(resolve => setTimeout(resolve, delay));

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                    throw new Error('Content blocked by safety filters');
                }
                
                return result;

            } catch (error) {
                if (attempt < MAX_RETRIES) {
                    console.warn(`Retry attempt ${attempt + 1}/${MAX_RETRIES}:`, error.message);
                    return callGeminiApiWithBackoff(payload, attempt + 1);
                } else {
                    throw error;
                }
            }
        }

        async function generatePlatformMetadata(resultItem, platform) {
            const file = resultItem.file;
            const extension = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png'].includes(extension);
            const isVector = ['ai', 'eps'].includes(extension);
            
            const config = PLATFORM_CONFIGS[platform];

            let base64Data = '';
            
            // For vector files with preview, use the preview
            if (isVector && resultItem.previewFile) {
                try {
                    base64Data = await fileToBase64(resultItem.previewFile);
                } catch (e) {
                    console.warn('Failed to read preview file:', e);
                }
            } else if (isImage) {
                try {
                    base64Data = await fileToBase64(file);
                } catch (e) {
                    throw new Error(`Failed to read image: ${e.message}`);
                }
            }

            const fileType = isImage ? 'Image' : (isVector ? 'Vector Graphics' : extension.toUpperCase());
            const userQuery = `Generate ${config.name} metadata for this ${fileType} asset. Filename: ${file.name}. CRITICAL REQUIREMENTS: Title must be ${config.titleMin}-${config.titleMax} characters with NO symbols/emojis. Generate MINIMUM ${config.keywordsMin} keywords. NO negative words. Only positive, descriptive, SEO-optimized content.`;

            const metadataSchema = {
                type: "OBJECT",
                properties: {
                    "title": { "type": "STRING" },
                    "description": { "type": "STRING" },
                    "keywords": { "type": "ARRAY", "items": { "type": "STRING" } }
                },
                "propertyOrdering": ["title", "description", "keywords"]
            };

            const payload = {
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: metadataSchema,
                    temperature: 0.7,
                    topP: 0.9,
                    topK: 40
                },
                systemInstruction: {
                    parts: [{ text: config.systemPrompt }]
                }
            };

            if (base64Data) {
                const mimeType = resultItem.previewFile ? resultItem.previewFile.type : file.type;
                payload.contents = [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }];
            } else {
                payload.contents = [{ 
                    role: "user",
                    parts: [{ text: userQuery }] 
                }];
            }

            const result = await callGeminiApiWithBackoff(payload);
            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                throw new Error('Empty AI response');
            }

            const parsedJson = JSON.parse(jsonText);

            // Clean and validate title
            let title = (parsedJson.title || file.name.substring(0, file.name.lastIndexOf('.')))
                .replace(/[^\w\s-]/g, '') // Remove all special characters except hyphens
                .replace(/\s+/g, ' ')      // Normalize spaces
                .trim();
            
            // Ensure title is within range
            if (title.length < config.titleMin) {
                const padding = ' Professional High Quality Stock Content for Commercial and Editorial Use';
                title = (title + padding).slice(0, config.titleMax);
            } else if (title.length > config.titleMax) {
                title = title.slice(0, config.titleMax).trim();
            }
            
            // Clean description
            const description = (parsedJson.description || 'Professional stock content')
                .slice(0, config.descMax)
                .trim();
            
            // Process and validate keywords
            let rawKeywords = Array.isArray(parsedJson.keywords) ? parsedJson.keywords : [];
            rawKeywords = rawKeywords.flatMap(k => 
                k.includes(',') ? k.split(',').map(s => s.trim()) : [k.trim()]
            );
            
            let keywords = [...new Set(rawKeywords
                .filter(k => k.length > 0 && k.length < 50)
                .map(k => k.toLowerCase().replace(/[^\w\s-]/g, '').trim())
                .filter(k => k.length > 0)
            )];
            
            // Ensure minimum keywords
            if (keywords.length < config.keywordsMin) {
                const genericKeywords = [
                    'professional', 'quality', 'design', 'creative', 'modern',
                    'business', 'concept', 'style', 'background', 'digital',
                    'illustration', 'graphic', 'template', 'layout', 'visual',
                    'content', 'commercial', 'stock', 'premium', 'editorial',
                    'marketing', 'branding', 'presentation', 'print', 'web'
                ];
                
                for (const gk of genericKeywords) {
                    if (keywords.length >= config.keywordsMin) break;
                    if (!keywords.includes(gk)) {
                        keywords.push(gk);
                    }
                }
            }
            
            // Limit to max
            keywords = keywords.slice(0, config.keywordsMax);
            
            return { title, description, keywords };
        }
        
        window.generateMetadata = async function() {
            if (state.files.length === 0 || state.selectedPlatforms.length === 0) return;
            
            if (state.apiKeyPool.length === 0) {
                showStatus('Please add at least one API key', 'error');
                showApiModal();
                return;
            }

            elements.analyzeBtn.disabled = true;
            elements.clearBtn.disabled = true;
            elements.spinner.classList.remove('hidden');
            elements.initialOutputPlaceholder.classList.add('hidden');

            let completed = 0;
            const total = state.files.length;

            // Process files in parallel with concurrency limit
            const concurrencyLimit = 3;
            
            for (let i = 0; i < state.files.length; i += concurrencyLimit) {
                const batch = state.results.slice(i, i + concurrencyLimit);
                
                await Promise.all(batch.map(async (resultItem) => {
                    const fileIndex = state.results.indexOf(resultItem);
                    
                    resultItem.status = 'processing';
                    renderOutput();

                    try {
                        // Process all platforms in parallel for this file
                        const platformPromises = state.selectedPlatforms.map(platform => 
                            generatePlatformMetadata(resultItem, platform)
                                .then(metadata => ({ platform, metadata }))
                        );
                        
                        const results = await Promise.all(platformPromises);
                        
                        results.forEach(({ platform, metadata }) => {
                            resultItem.platformMetadata[platform] = metadata;
                        });
                        
                        resultItem.status = 'complete';
                        completed++;
                        elements.analyzeText.textContent = `Processing ${completed}/${total} files...`;
                        
                    } catch (error) {
                        console.error(`Error processing ${resultItem.file.name}:`, error);
                        resultItem.status = 'error';
                        
                        state.selectedPlatforms.forEach(platform => {
                            resultItem.platformMetadata[platform] = {
                                title: `Error Processing ${resultItem.file.name}`,
                                description: error.message.slice(0, 200),
                                keywords: ['error', 'processing', 'failed']
                            };
                        });
                        
                        showStatus(`Failed: ${resultItem.file.name}`, 'error');
                    }
                    
                    renderOutput();
                }));
            }

            elements.analyzeBtn.disabled = false;
            elements.clearBtn.disabled = false;
            elements.spinner.classList.add('hidden');
            elements.analyzeText.textContent = 'Batch Complete! Generate Again?';
            showStatus(`Batch complete! Processed ${completed}/${total} files`, 'success');
            updateDownloadButtons();
        }
        
        function sanitizeTitleForFilename(title, maxLength = 100) {
            let cleanTitle = title
                .replace(/[^a-zA-Z0-9\-_ ]/g, '')
                .replace(/\s+/g, '_')
                .trim();
            return cleanTitle.slice(0, maxLength);
        }

        window.createZipAndDownload = async function(platform) {
            const completedResults = state.results.filter(r => r.status === 'complete' && r.platformMetadata[platform]);
            if (completedResults.length === 0) {
                showStatus(`No files ready for ${PLATFORM_CONFIGS[platform].name}`, 'error');
                return;
            }

            const zip = new JSZip();

            try {
                await Promise.all(completedResults.map(async (item) => {
                    const metadata = item.platformMetadata[platform];
                    const title = metadata.title;
                    const extension = item.file.name.substring(item.file.name.lastIndexOf('.'));
                    
                    const cleanTitle = sanitizeTitleForFilename(title); 
                    const newFileName = `${cleanTitle}${extension}`;
                    zip.file(newFileName, item.file);
                }));

                const zipBlob = await zip.generateAsync({ 
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                });

                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `${PLATFORM_CONFIGS[platform].name.replace(/\s/g, '_')}_${date}.zip`;
                
                const link = document.createElement("a");
                link.href = URL.createObjectURL(zipBlob);
                link.download = filename;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Cleanup
                setTimeout(() => URL.revokeObjectURL(link.href), 100);

                showStatus(`ZIP downloaded: ${filename}`, 'success');

            } catch (error) {
                console.error("ZIP Error:", error);
                showStatus(`Failed to create ZIP: ${error.message}`, 'error');
            }
        }

        function csvEscape(value) {
            if (value === null || value === undefined) return "";
            let str = String(value);
            str = str.replace(/"/g, '""'); 
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str}"`;
            }
            return str;
        }

        window.downloadCsv = function(mode) {
            const completedResults = state.results.filter(r => r.status === 'complete');
            if (completedResults.length === 0) {
                showStatus('No completed files for CSV', 'error');
                return;
            }

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');

            if (mode === 'all') {
                state.selectedPlatforms.forEach(platform => {
                    const config = PLATFORM_CONFIGS[platform];
                    const headers = ['Filename', 'Title', 'Description', 'Keywords']; 
                    let csvContent = headers.map(csvEscape).join(',') + '\n';

                    completedResults.forEach(item => {
                        if (item.platformMetadata[platform]) {
                            const metadata = item.platformMetadata[platform];
                            const title = metadata.title;
                            const extension = item.file.name.substring(item.file.name.lastIndexOf('.'));
                            
                            const newFileName = sanitizeTitleForFilename(title) + extension;
                            const keywordsString = metadata.keywords.join(', ');

                            const row = [
                                newFileName,
                                metadata.title,
                                metadata.description,
                                keywordsString
                            ];

                            csvContent += row.map(csvEscape).join(',') + '\n';
                        }
                    });

                    const filename = `${config.name.replace(/\s/g, '_')}_Metadata_${date}.csv`;
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Cleanup
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                });
                
                showStatus(`CSV files downloaded for ${state.selectedPlatforms.length} platforms`, 'success');
            }
        }
        
        window.clearAll = function() {
            if (!confirm('Clear all files and results?')) return;
            
            elements.fileInput.value = '';
            elements.fileNameDisplay.textContent = 'Click or drag files here (Max 25)';
            elements.analyzeBtn.disabled = true;
            elements.clearBtn.disabled = true;
            elements.analysisMethod.textContent = '';
            
            clearPreview();
            updateDownloadButtons();
            
            showStatus('All cleared', 'info');
        }

        // --- Platform Tab Switching ---
        window.switchPlatformTab = function(id, platform) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem) {
                resultItem.activePlatform = platform;
                renderOutput();
            }
        }

        // --- UI RENDERING ---
        
        window.toggleResult = function(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.add('rotate-180');
            }
        }

        function createResultHtml(result) {
            const { file, platformMetadata, status, id, thumbnail, activePlatform } = result;
            const extension = file.name.split('.').pop().toLowerCase();
            const isVector = ['ai', 'eps'].includes(extension);
            
            let statusText = '';
            let statusColor = 'text-gray-500';
            let bgColor = 'bg-gray-50';

            if (status === 'complete') {
                statusText = 'Completed'; 
                statusColor = 'text-green-700';
                bgColor = 'bg-green-50';
            } else if (status === 'processing') {
                statusText = 'Processing...'; 
                statusColor = 'text-yellow-700';
                bgColor = 'bg-yellow-50';
            } else if (status === 'pending') {
                statusText = 'Pending';
                statusColor = 'text-gray-700';
                bgColor = 'bg-gray-50';
            } else if (status === 'error') {
                statusText = 'Error';
                statusColor = 'text-red-700';
                bgColor = 'bg-red-50';
            }
            
            const isExpanded = status === 'processing' || status === 'error' || status === 'complete'; 
            
            const thumbnailHtml = `
                <div class="relative">
                    <img src="${thumbnail}" 
                        alt="${file.name} thumbnail" 
                        class="preview-thumbnail"
                        onerror="this.onerror=null; this.src='${getFileIcon('generic')}';"
                    />
                    ${isVector && status === 'pending' ? `
                        <button onclick="uploadPreviewImage('${id}')" 
                            class="preview-upload-btn absolute bottom-1 left-1 right-1"
                            title="Upload JPG preview for better AI analysis">
                            Upload JPG Preview
                        </button>
                    ` : ''}
                </div>
            `;

            const platformTabs = state.selectedPlatforms.map(platform => {
                const isActive = platform === activePlatform;
                const badgeClass = `platform-${platform}`;
                return `
                    <button onclick="switchPlatformTab('${id}', '${platform}')" 
                        class="platform-tab ${isActive ? 'active' : ''} flex-1"
                        aria-label="View ${PLATFORM_CONFIGS[platform].name} metadata">
                        <span class="platform-badge ${badgeClass}">${PLATFORM_CONFIGS[platform].name}</span>
                    </button>
                `;
            }).join('');

            const activeMetadata = platformMetadata[activePlatform] || { title: '', description: '', keywords: [] };
            const config = PLATFORM_CONFIGS[activePlatform] || PLATFORM_CONFIGS.adobe;
            
            const titleLength = activeMetadata.title.length;
            const isTitleValid = titleLength >= config.titleMin && titleLength <= config.titleMax;
            const charCountClass = isTitleValid ? 'char-success' : 'char-warning';
            
            const keywordCount = activeMetadata.keywords.length;
            const isKeywordValid = keywordCount >= config.keywordsMin && keywordCount <= config.keywordsMax;
            const isBelowMin = keywordCount < config.keywordsMin;
            const keywordCountClass = isBelowMin ? 'keyword-count-warning' : (isKeywordValid ? 'keyword-count-success' : 'keyword-count-info');

            return `
                <div id="result-${id}" class="result-item ${bgColor} p-4 rounded-lg border border-200 shadow-sm transition-all duration-300" role="listitem">
                    <div class="flex justify-between items-start cursor-pointer" onclick="toggleResult('${id}')">
                        <div class="flex items-start space-x-4 flex-1 min-w-0">
                            ${thumbnailHtml}
                            <div class="flex-1 min-w-0">
                                <span class="font-bold text-lg text-gray-800 block truncate">${file.name}</span>
                                <span class="text-sm font-semibold ${statusColor} block mt-1">${statusText}</span>
                                ${state.selectedPlatforms.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${state.selectedPlatforms.map(p => `<span class="platform-badge platform-${p} text-xs">${PLATFORM_CONFIGS[p].name}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-500 transform transition-transform flex-shrink-0 ml-2 ${isExpanded ? '' : 'rotate-180'}" id="icon-${id}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <div id="content-${id}" class="mt-4 space-y-4 ${isExpanded ? '' : 'hidden'}">
                        
                        ${state.selectedPlatforms.length > 1 ? `
                            <div class="flex border-b border-gray-200" role="tablist">
                                ${platformTabs}
                            </div>
                        ` : ''}

                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500" for="title-input-${id}-${activePlatform}">Title for ${config.name}</label>
                                <span class="edit-indicator">‚úé Editable</span>
                            </div>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="title-input-${id}-${activePlatform}" 
                                    value="${activeMetadata.title.replace(/"/g, '&quot;')}"
                                    oninput="updateMetadata('${id}', '${activePlatform}', 'title', this.value)"
                                    class="editable-input w-full text-sm font-medium text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded focus:ring-2 focus:ring-indigo-500"
                                    maxlength="${config.titleMax}"
                                    aria-label="Edit title"
                                />
                                <button onclick="copyDynamicToClipboard('title-input-${id}-${activePlatform}', this)" class="copy-btn absolute right-0 top-0 h-full px-3 text-gray-600 rounded-r-lg" title="Copy Title">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p id="char-count-${id}-${activePlatform}" class="text-xs mt-1 ${charCountClass}" aria-live="polite">${titleLength}/${config.titleMax} (Required: ${config.titleMin}-${config.titleMax})</p>
                        </div>

                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500" for="desc-input-${id}-${activePlatform}">Description</label>
                                <span class="edit-indicator">‚úé Editable</span>
                            </div>
                            <div class="relative">
                                <textarea 
                                    id="desc-input-${id}-${activePlatform}"
                                    onchange="updateMetadata('${id}', '${activePlatform}', 'description', this.value)"
                                    class="editable-textarea w-full text-sm text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded resize-none focus:ring-2 focus:ring-indigo-500"
                                    rows="2"
                                    maxlength="${config.descMax}"
                                >${activeMetadata.description}</textarea>
                                <button onclick="copyDynamicToClipboard('desc-input-${id}-${activePlatform}', this)" class="copy-btn absolute right-0 top-0 h-10 w-10 text-gray-600 rounded-tr-lg" title="Copy Description">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${activeMetadata.description.length}/${config.descMax} characters</p>
                        </div>

                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500" for="keywords-input-${id}-${activePlatform}">Keywords</label>
                                <span class="edit-indicator">‚úé Editable</span>
                            </div>
                            <p id="keyword-count-${id}-${activePlatform}" class="text-xs mb-2 ${keywordCountClass}" aria-live="polite">
                                ${keywordCount}/${config.keywordsMax} (Min: ${config.keywordsMin})
                                ${isBelowMin ? ' ‚ö†Ô∏è Below minimum' : ''}
                            </p>
                            <div class="relative">
                                <textarea 
                                    id="keywords-input-${id}-${activePlatform}"
                                    oninput="updateMetadata('${id}', '${activePlatform}', 'keywords', this.value)"
                                    class="editable-textarea w-full text-sm text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded resize-none focus:ring-2 focus:ring-indigo-500"
                                    rows="3"
                                    placeholder="Comma-separated keywords"
                                >${activeMetadata.keywords.join(', ')}</textarea>
                                <button onclick="copyDynamicToClipboard('keywords-input-${id}-${activePlatform}', this)" class="copy-btn absolute right-0 top-0 h-10 w-10 text-gray-600 rounded-tr-lg" title="Copy Keywords">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            
                            ${activeMetadata.keywords.length > 0 ? `
                                <div class="mt-2 pt-2 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-1">Preview:</p>
                                    <div class="text-xs max-h-20 overflow-y-auto">
                                        ${activeMetadata.keywords.map(k => `<span class="keyword-pill">${k}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                    </div>
                </div>
            `;
        }
        
        function renderOutput() {
            elements.resultsCount.textContent = state.files.length;
            elements.resultsContainer.innerHTML = '';
            
            elements.clearBtn.disabled = state.files.length === 0;

            if (state.results.length === 0) {
                elements.initialOutputPlaceholder.classList.remove('hidden');
            } else {
                elements.initialOutputPlaceholder.classList.add('hidden');
                state.results.forEach(result => {
                    elements.resultsContainer.insertAdjacentHTML('beforeend', createResultHtml(result));
                });
            }
            
            updateDownloadButtons();
        }

        window.copyDynamicToClipboard = function(elementId, button) {
            const element = document.getElementById(elementId);
            const textToCopy = element.value || element.textContent;
            
            copyTextLogic(textToCopy, button);
        }

        window.copyRawTextToClipboard = function(textToCopy, button) {
            copyTextLogic(textToCopy, button);
        }

        function copyTextLogic(textToCopy, button) {
             if (!textToCopy) {
                showStatus('Field is empty', 'error');
                return;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showStatus('Copied to clipboard!', 'success');
                
                const originalHTML = button.innerHTML;
                button.innerHTML = `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 1500);
            }).catch(err => {
                console.error('Copy failed:', err);
                showStatus('Copy failed', 'error');
            });
        }

        function showStatus(message, type) {
            elements.statusMessage.textContent = message;
            elements.statusMessage.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-gray-800', 'bg-green-600');
            elements.statusMessage.classList.add('opacity-100');
            
            if (type === 'success') {
                elements.statusMessage.classList.add('bg-green-600');
            } else if (type === 'error') {
                elements.statusMessage.classList.add('bg-red-500');
            } else {
                elements.statusMessage.classList.add('bg-gray-800');
            }

            setTimeout(() => {
                elements.statusMessage.classList.remove('opacity-100');
                elements.statusMessage.classList.add('opacity-0');
                setTimeout(() => {
                    elements.statusMessage.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeyPool();
            renderOutput();
            updatePlatformSelection();
        });
    </script>
</body>
</html>
