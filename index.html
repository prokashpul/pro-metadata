<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adobe Stock Metadata Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --adobe-red: #FA0000;
            --adobe-red-dark: #D60000;
        }
        
        /* Light Mode Colors */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            padding-top: 4.5rem;
            padding-bottom: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Mode Colors */
        body.dark-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.dark-mode .card {
            background-color: #1e293b;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background-color: var(--adobe-red);
            transition: background-color 0.15s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: var(--adobe-red-dark);
        }
        .btn-primary:active {
            transform: scale(0.99);
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            transition: background-color 0.15s, transform 0.1s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        
        body.dark-mode .btn-secondary {
            background-color: #334155;
            color: #cbd5e1;
        }
        
        body.dark-mode .btn-secondary:hover {
            background-color: #475569;
        }
        
        .file-input-label {
            cursor: pointer;
            border: 3px dashed #cbd5e1;
            text-align: center;
            border-radius: 0.75rem;
            background-color: #fef2f2;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-input-label:hover {
            border-color: var(--adobe-red);
            background-color: #fee2e2;
        }
        
        body.dark-mode .file-input-label {
            background-color: #1e293b;
            border-color: #475569;
        }
        
        body.dark-mode .file-input-label:hover {
            border-color: var(--adobe-red);
            background-color: #334155;
        }
        
        .copy-btn {
            background-color: #f1f5f9;
            transition: background-color 0.1s;
        }
        .copy-btn:hover {
            background-color: #e2e8f0;
        }
        .copy-btn:active {
            transform: scale(0.99);
        }
        
        body.dark-mode .copy-btn {
            background-color: #334155;
        }
        
        body.dark-mode .copy-btn:hover {
            background-color: #475569;
        }
        
        .keyword-pill {
            display: inline-flex;
            padding: 0.3rem 0.75rem;
            margin: 0.25rem;
            background-color: #FA0000;
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .keyword-extra {
             background-color: #3b82f6;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Preview thumbnail size */
        .preview-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body.dark-mode .preview-thumbnail {
            border-color: #475569;
        }
        
        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        body.dark-mode #main-header {
            background-color: #1e293b;
            border-bottom-color: #334155;
        }
        
        #apiModal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        /* Dark mode for modal backdrop */
        body.dark-mode #apiModal {
            background-color: rgba(0, 0, 0, 0.85);
        }
        
        /* Footer Styles */
        #main-footer {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            margin-top: 4rem;
            transition: background 0.3s ease;
        }
        
        body.dark-mode #main-footer {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        }
        
        .footer-link {
            color: #cbd5e1;
            transition: color 0.2s;
        }
        .footer-link:hover {
            color: var(--adobe-red);
        }
        .tech-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            font-size: 0.75rem;
            margin: 0.25rem;
        }
        
        /* Dark mode toggle button */
        .theme-toggle {
            background-color: #f1f5f9;
            transition: background-color 0.2s;
        }
        
        .theme-toggle:hover {
            background-color: #e2e8f0;
        }
        
        body.dark-mode .theme-toggle {
            background-color: #334155;
        }
        
        body.dark-mode .theme-toggle:hover {
            background-color: #475569;
        }
        
        /* Editable field styles */
        .editable-input,
        .editable-textarea {
            transition: all 0.2s ease;
            background-color: transparent;
        }
        
        .editable-input:focus,
        .editable-textarea:focus {
            outline: none;
            background-color: #f8fafc;
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .editable-input:focus,
        body.dark-mode .editable-textarea:focus {
            background-color: #0f172a;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .edit-indicator {
            font-size: 0.65rem;
            color: #6366f1;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Text color adjustments for dark mode */
        body.dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .text-gray-500 {
            color: #64748b !important;
        }
        
        body.dark-mode .text-gray-400 {
            color: #475569 !important;
        }
        
        /* Border colors for dark mode */
        body.dark-mode .border-gray-200 {
            border-color: #334155 !important;
        }
        
        body.dark-mode .border-gray-300 {
            border-color: #475569 !important;
        }
        
        body.dark-mode .border-gray-700 {
            border-color: #1e293b !important;
        }
        
        /* Background colors for dark mode */
        body.dark-mode .bg-white {
            background-color: #1e293b !important;
        }
        
        body.dark-mode .bg-gray-50 {
            background-color: #334155 !important;
        }
        
        body.dark-mode .bg-gray-100 {
            background-color: #475569 !important;
        }
        
        body.dark-mode .bg-green-50 {
            background-color: #14532d !important;
        }
        
        body.dark-mode .bg-yellow-50 {
            background-color: #422006 !important;
        }
        
        body.dark-mode .bg-red-50 {
            background-color: #450a0a !important;
        }
        
        /* Input fields in dark mode */
        body.dark-mode input[type="text"],
        body.dark-mode textarea {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        body.dark-mode input[type="text"]:focus,
        body.dark-mode textarea:focus {
            border-color: #6366f1;
            background-color: #1e293b;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- FIXED HEADER -->
    <header id="main-header" class="p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                 <h1 class="text-2xl font-extrabold text-gray-900">
                    <span style="color:var(--adobe-red);">Adobe Stock</span> Metadata Pro
                </h1>
                <span class="hidden sm:inline text-sm text-gray-500 font-medium ml-4">
                    AI-powered batch analysis
                </span>
            </div>
            
            <div class="flex items-center space-x-2">
                <!-- Dark Mode Toggle Button -->
                <button onclick="toggleDarkMode()" 
                    class="theme-toggle p-2 rounded-lg transition duration-150" 
                    title="Toggle dark mode"
                    aria-label="Toggle dark mode">
                    <svg id="sunIcon" class="w-5 h-5 text-gray-700 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moonIcon" class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                
                <button onclick="showApiModal()" 
                    class="px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.996.608 2.245.54 3.14-.078z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="hidden sm:inline">Add APIs</span>
                    <span class="inline sm:hidden">APIs</span>
                </button>
            </div>
        </div>
    </header>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-8">
        
        <!-- Main Application Description -->
        <header class="text-center mb-12">
            <p class="text-xl text-gray-600 mt-3">
                Quickly generate highly optimized metadata for your batch of stock assets.
            </p>
        </header>


        <div class="grid grid-cols-1 lg:col-span-3 gap-8">

            <!-- UPLOAD AND CONTROLS (Left Column) -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">1. Upload Files</h2>
                    
                    <!-- File Preview Area -->
                    <div id="filePreviewContainer" class="mb-4 w-full h-24 flex flex-col items-center justify-center">
                        <svg id="filePlaceholderIcon" class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        <p id="filePreviewText" class="text-gray-600 font-semibold">No files selected.</p>
                    </div>
                    
                    <div class="input-group mb-6">
                        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.ai,.eps,.mp4,.mov" class="hidden" onchange="handleFileChange(this)" multiple>
                        <label for="fileInput" class="file-input-label block p-6 sm:p-10">
                            <span class="text-lg font-semibold block mb-1 text-gray-700" id="fileNameDisplay">Click or drag files here (Max 25)</span>
                            <span class="text-sm text-gray-500 block">JPG, PNG, EPS, AI, MOV, MP4 supported.</span>
                        </label>
                    </div>

                    <div class="space-y-3">
                        <button id="analyzeBtn" onclick="generateMetadata()" 
                            class="btn-primary w-full text-white py-3 rounded-lg font-bold flex items-center justify-center disabled:opacity-50" disabled>
                            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="analyzeText">Generate Metadata for Batch</span>
                        </button>
                        
                        <button id="clearBtn" onclick="clearAll()" 
                            class="btn-secondary w-full py-3 rounded-lg font-bold flex items-center justify-center disabled:opacity-50" disabled>
                            Clear All Files & Results
                        </button>
                        
                    </div>
                    <p id="analysisMethod" class="text-xs text-center text-gray-500 mt-3"></p>
                </div>
            </div>

            <!-- METADATA OUTPUT (Right Columns) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">2. Generated Metadata (<span id="resultsCount">0</span> Files)</h2>
                    
                    <!-- Grouped Download Buttons -->
                    <div class="flex space-x-4 mb-4"> 
                        <button id="downloadZipBtn" onclick="createZipAndDownload()" 
                            class="flex-1 px-4 py-2 text-sm font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700 disabled:opacity-50 flex items-center justify-center" disabled>
                            <svg id="zipSpinner" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="zipButtonText">Download ZIP (<span id="downloadReadyCount">0</span> files)</span>
                        </button>
                        
                        <button id="downloadCsvBtn" onclick="downloadCsv()" 
                            class="flex-1 px-4 py-2 text-sm font-semibold text-gray-800 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50" disabled>
                            Download CSV Metadata
                        </button>
                    </div>
                    
                    <!-- Container for all results -->
                    <div id="resultsContainer" class="space-y-4">
                        <p id="initialOutputPlaceholder" class="text-gray-400 italic">Upload and analyze files to see results here.</p>
                        <!-- Dynamic file results will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Message Box -->
        <div id="statusMessage" class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50" role="alert">
            <!-- Messages appear here -->
        </div>

    </div>
    
    <!-- FOOTER SECTION -->
    <footer id="main-footer" class="mt-16 py-8 border-t border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                
                <!-- Column 1: Branding & Description -->
                <div class="space-y-3">
                    <h3 class="text-lg font-bold text-white">
                        <span style="color:var(--adobe-red);">Adobe Stock</span> Metadata Pro
                    </h3>
                    <p class="text-sm text-gray-400">
                        AI-powered batch metadata generation tool for professional stock content creators. Optimize your workflow with intelligent SEO suggestions.
                    </p>
                    <p class="text-xs text-gray-500">
                        Version 1.0.0 | Updated 2025
                    </p>
                </div>

                <!-- Column 2: Tech Stack -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider">Powered By</h4>
                    <div class="flex flex-wrap">
                        <span class="tech-badge">🤖 Google Gemini 2.5</span>
                        <span class="tech-badge">⚡ Tailwind CSS</span>
                        <span class="tech-badge">📦 JSZip</span>
                        <span class="tech-badge">🎨 Inter Font</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Built with cutting-edge AI and modern web technologies.
                    </p>
                </div>

                <!-- Column 3: Links & Info -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider">Resources</h4>
                    <ul class="space-y-2 text-sm">
                        <li>
                            <a href="https://stock.adobe.com" target="_blank" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Adobe Stock</span>
                            </a>
                        </li>
                        <li>
                            <a href="https://ai.google.dev/gemini-api" target="_blank" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                <span>Gemini API Docs</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="showApiModal(); return false;" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.996.608 2.245.54 3.14-.078z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>Configure API Keys</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="pt-6 border-t border-gray-700 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <p class="text-xs text-gray-500">
                    © 2025 Adobe Stock Metadata Pro. Not officially affiliated with Adobe Inc.
                </p>
                <div class="flex items-center space-x-4 text-xs text-gray-500">
                    <span class="flex items-center space-x-1">
                        <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span>Client-side Processing</span>
                    </span>
                    <span class="flex items-center space-x-1">
                        <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                        <span>Privacy Focused</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- API KEY MODAL -->
    <div id="apiModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 invisible opacity-0">
        <div class="card w-full max-w-lg p-6 sm:p-8 transform transition-all duration-300 scale-95">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-gray-900">Configure API Keys</h3>
                <button onclick="hideApiModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <p class="text-sm text-gray-600 mb-4">
                Enter your Google Gemini API key here to override the default Canvas environment key.
            </p>

            <form id="apiForm" onsubmit="saveApiKeys(event)">
                <div class="space-y-4">
                    <label for="geminiApiKey" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="text" id="geminiApiKey" name="geminiApiKey" placeholder="AIzaSy..."
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Multipool API Key Section -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Multipool API Keys</h4>
                    <p class="text-sm text-gray-600 mb-3">Add or remove API keys for your mining pools.</p>
                    
                    <!-- Add Key Input Group -->
                    <label for="multipoolApiKeyInput" class="block text-sm font-medium text-gray-700">New Multipool Key</label>
                    <div class="mt-1 flex space-x-2">
                        <input type="text" id="multipoolApiKeyInput" placeholder="Enter new pool key..."
                            class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <button type="button" onclick="addMultipoolKey()"
                            class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">
                            Add
                        </button>
                    </div>
                    
                    <!-- Key List -->
                    <div id="multipoolKeyListContainer" class="mt-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Saved Multipool Keys</label>
                        <div id="multipoolKeyList" class="max-h-32 overflow-y-auto space-y-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                            <p id="noMultipoolKeysText" class="text-xs text-gray-400 italic text-center py-2">No multipool keys added.</p>
                        </div>
                    </div>
                </div>
                
                <div id="apiStatusMessage" class="mt-4 text-xs font-medium text-center text-indigo-600">
                    <!-- Status of the API key goes here -->
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideApiModal()" class="btn-secondary px-4 py-2 rounded-lg font-semibold">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">
                        Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // --- Dark Mode Functionality ---
        const DARK_MODE_STORAGE = 'adobeStockPro_darkMode';
        
        function initDarkMode() {
            const savedDarkMode = localStorage.getItem(DARK_MODE_STORAGE);
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                updateDarkModeIcons(true);
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem(DARK_MODE_STORAGE, isDark);
            updateDarkModeIcons(isDark);
        }
        
        function updateDarkModeIcons(isDark) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (isDark) {
                sunIcon.classList.remove('hidden');
                sunIcon.classList.add('text-gray-300');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                moonIcon.classList.add('text-gray-700');
            }
        }
        
        // Initialize dark mode on page load
        initDarkMode();
        
        // --- Core Application Logic & State ---
        const MAX_RETRIES = 3;

        const GEMINI_API_KEY_STORAGE = 'adobeStockPro_geminiKey';
        const MULTIPOOL_KEYS_STORAGE = 'adobeStockPro_multipoolKeys';

        const state = {
            files: [],
            results: [],
            maxFiles: 25,
            userApiKey: localStorage.getItem(GEMINI_API_KEY_STORAGE) || '',
            multipoolKeys: JSON.parse(localStorage.getItem(MULTIPOOL_KEYS_STORAGE) || '[]')
        };
        
        function getApiKey() {
            return state.userApiKey || ""; 
        }

        const elements = {
            fileInput: document.getElementById('fileInput'),
            fileNameDisplay: document.getElementById('fileNameDisplay'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            spinner: document.getElementById('spinner'),
            analyzeText: document.getElementById('analyzeText'),
            statusMessage: document.getElementById('statusMessage'),
            filePreviewContainer: document.getElementById('filePreviewContainer'),
            filePlaceholderIcon: document.getElementById('filePlaceholderIcon'),
            filePreviewText: document.getElementById('filePreviewText'),
            analysisMethod: document.getElementById('analysisMethod'),
            resultsContainer: document.getElementById('resultsContainer'),
            initialOutputPlaceholder: document.getElementById('initialOutputPlaceholder'),
            resultsCount: document.getElementById('resultsCount'),
            downloadZipBtn: document.getElementById('downloadZipBtn'),
            downloadCsvBtn: document.getElementById('downloadCsvBtn'), 
            downloadReadyCount: document.getElementById('downloadReadyCount'),
            zipSpinner: document.getElementById('zipSpinner'),
            zipButtonText: document.getElementById('zipButtonText'),
            clearBtn: document.getElementById('clearBtn'), 
            apiModal: document.getElementById('apiModal'),
            geminiApiKeyInput: document.getElementById('geminiApiKey'),
            apiStatusMessage: document.getElementById('apiStatusMessage'),
            multipoolApiKeyInput: document.getElementById('multipoolApiKeyInput'),
            multipoolKeyList: document.getElementById('multipoolKeyList'),
        };

        // --- Editable Field Functions ---
        
        window.updateTitle = function(id, value) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem) {
                resultItem.metadata.title = value;
            }
        }
        
        window.updateDescription = function(id, value) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem) {
                resultItem.metadata.description = value;
            }
        }
        
        window.updateKeywords = function(id, value) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem) {
                // Split by comma and clean up
                const keywords = value.split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
                resultItem.metadata.keywords = [...new Set(keywords)]; // Remove duplicates
            }
        }

        // --- API Modal Functions ---
        window.showApiModal = function() {
            elements.geminiApiKeyInput.value = state.userApiKey;
            elements.apiStatusMessage.textContent = state.userApiKey ? "Using custom API key." : "Using default environment key.";
            renderMultipoolKeysList();
            elements.apiModal.classList.remove('invisible', 'opacity-0');
            elements.apiModal.classList.add('opacity-100');
        }

        window.hideApiModal = function() {
            elements.apiModal.classList.remove('opacity-100');
            elements.apiModal.classList.add('invisible', 'opacity-0');
        }

        window.saveApiKeys = function(event) {
            event.preventDefault();
            const newKey = elements.geminiApiKeyInput.value.trim();
            
            if (newKey && newKey.length < 20) {
                 elements.apiStatusMessage.textContent = "Key looks too short. Please check it.";
                 return;
            }

            state.userApiKey = newKey;
            localStorage.setItem(GEMINI_API_KEY_STORAGE, newKey);
            
            if (newKey) {
                 elements.apiStatusMessage.textContent = "Gemini API key saved successfully!";
                 showStatus('Custom Gemini API key saved.', 'success');
            } else {
                 elements.apiStatusMessage.textContent = "Switched back to using the default environment key.";
                 showStatus('Switched to default API key.', 'info');
            }
            
            setTimeout(hideApiModal, 1000);
        }

        // --- Multipool Key Functions ---

        function renderMultipoolKeysList() {
            elements.multipoolKeyList.innerHTML = '';
            
            if (state.multipoolKeys.length === 0) {
                elements.multipoolKeyList.innerHTML = '<p id="noMultipoolKeysText" class="text-xs text-gray-400 italic text-center py-2">No multipool keys added.</p>';
                return;
            }
            
            state.multipoolKeys.forEach(keyItem => {
                const maskedKey = keyItem.key.length > 8 
                    ? `${keyItem.key.substring(0, 4)}...${keyItem.key.substring(keyItem.key.length - 4)}` 
                    : keyItem.key;

                const keyHtml = `
                    <div class="flex items-center justify-between bg-white p-2 rounded-md border border-gray-300">
                        <span class="text-sm font-mono text-gray-700">${maskedKey}</span>
                        <button type="button" onclick="removeMultipoolKey('${keyItem.id}')"
                            class="px-2 py-1 text-xs font-semibold text-red-600 hover:bg-red-100 rounded-md transition duration-150">
                            Remove
                        </button>
                    </div>
                `;
                elements.multipoolKeyList.insertAdjacentHTML('beforeend', keyHtml);
            });
        }

        window.addMultipoolKey = function() {
            const newKey = elements.multipoolApiKeyInput.value.trim();
            if (newKey.length < 5) {
                showStatus('Multipool key appears too short.', 'error');
                return;
            }
            
            if (state.multipoolKeys.some(k => k.key === newKey)) {
                 showStatus('This multipool key has already been added.', 'error');
                 return;
            }

            state.multipoolKeys.push({
                id: crypto.randomUUID(),
                key: newKey
            });
            
            localStorage.setItem(MULTIPOOL_KEYS_STORAGE, JSON.stringify(state.multipoolKeys));
            
            elements.multipoolApiKeyInput.value = '';
            renderMultipoolKeysList();
            showStatus('Multipool key added.', 'success');
        }

        window.removeMultipoolKey = function(id) {
            state.multipoolKeys = state.multipoolKeys.filter(k => k.id !== id);
            localStorage.setItem(MULTIPOOL_KEYS_STORAGE, JSON.stringify(state.multipoolKeys));
            renderMultipoolKeysList();
            showStatus('Multipool key removed.', 'info');
        }

        // --- Utility Functions ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function getFileIcon(extension) {
            const defaultColor = '#5e5e5e'; 
            let svgPath = '';

            if (extension === 'video' || extension === 'mp4' || extension === 'mov') {
                svgPath = `<path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 10h7a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2a1 1 0 011-1z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else if (extension === 'ai' || extension === 'eps') {
                svgPath = `<path d="M12 20h9M16.5 3.5l-3 3L8 15l-3 3 6-6 3-3 3.5-3.5a2.121 2.121 0 013 3z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else {
                svgPath = `<path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13 2v7h7" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            }

            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">${svgPath}</svg>`;
            return `data:image/svg+xml;base64,${btoa(svg)}`;
        }
        
        async function getThumbnailData(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png'].includes(extension);
            const isVideo = ['mp4', 'mov'].includes(extension);
            const isVector = ['ai', 'eps'].includes(extension);

            if (isImage) {
                return fileToDataUrl(file);
            } else if (isVideo) {
                return getFileIcon('video');
            } else if (isVector) {
                return getFileIcon(extension);
            } else {
                return getFileIcon('generic');
            }
        }

        function clearPreview() {
            state.files = [];
            state.results = [];

            elements.filePlaceholderIcon.classList.remove('hidden');
            elements.filePlaceholderIcon.innerHTML = `<svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`;
            elements.filePreviewText.textContent = 'No files selected.';

            elements.analyzeText.textContent = 'Generate Metadata for Batch';
            
            renderOutput();
        }

        window.handleFileChange = async function(input) {
            if (input.files.length === 0) {
                elements.fileNameDisplay.textContent = 'Click or drag files here (Max 25)';
                elements.analyzeBtn.disabled = true;
                elements.clearBtn.disabled = true;
                elements.analysisMethod.textContent = '';
                clearPreview();
                return;
            }
            
            const selectedFiles = Array.from(input.files).slice(0, state.maxFiles);
            state.files = selectedFiles;
            
            const filePromises = selectedFiles.map(async (file) => ({
                file,
                status: 'pending',
                metadata: { title: file.name.substring(0, file.name.lastIndexOf('.')), description: 'Ready for analysis...', keywords: [] },
                extras: { keywords: [], titles: [] },
                id: crypto.randomUUID(),
                thumbnail: await getThumbnailData(file)
            }));

            state.results = await Promise.all(filePromises);

            elements.fileNameDisplay.textContent = `${state.files.length} file(s) selected.`;
            elements.filePreviewText.textContent = `Ready to process ${state.files.length} file(s).`;
            elements.analyzeBtn.disabled = false;
            elements.clearBtn.disabled = false;
            elements.analysisMethod.textContent = `Batch mode. Processing ${state.files.length} file(s).`;

            renderOutput();
        }

        async function callGeminiApiWithBackoff(payload, attempt = 0) {
            const currentKey = getApiKey();
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`;
            
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
            if (attempt > 0) await new Promise(resolve => setTimeout(resolve, delay));

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                    throw new Error('Content was blocked due to safety settings.');
                }
                
                return result;

            } catch (error) {
                if (attempt < MAX_RETRIES - 1) {
                    return callGeminiApiWithBackoff(payload, attempt + 1);
                } else {
                    console.error("Gemini API Error after max retries:", error);
                    throw new Error(`Failed to get a response from AI after max attempts: ${error.message}`);
                }
            }
        }

        async function generateSingleMetadata(resultItem) {
            const file = resultItem.file;
            const extension = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png'].includes(extension);
            
            const MAX_TITLE_LENGTH = 190;

            let base64Data = '';
            if (isImage) {
                try {
                    base64Data = await fileToBase64(file);
                } catch (e) {
                    throw new Error(`Failed to read image file: ${e.message}`);
                }
            }

            const systemPrompt = "You are a world-class Adobe Stock SEO expert. Generate metadata for stock images/videos. The tags must be a list of 49 unique, high-value, commercially relevant keywords. The Title must be highly descriptive, SEO-friendly (Title Case), and between 150 and 190 characters long. The Description must be engaging and detailed (max 200 chars). Return the result only as a JSON object matching the provided schema.";
            
            const userQuery = `Generate Adobe Stock metadata for this asset (File Type: ${isImage ? 'Image' : extension.toUpperCase()}, Filename: ${file.name}). Focus on commercial value and searchability.`;

            const metadataSchema = {
                type: "OBJECT",
                properties: {
                    "title": { "type": "STRING" },
                    "description": { "type": "STRING" },
                    "keywords": { "type": "ARRAY", "items": { "type": "STRING" } }
                },
                "propertyOrdering": ["title", "description", "keywords"]
            };

            const payload = {
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: metadataSchema
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            if (base64Data) {
                payload.contents = [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: file.type, data: base64Data } }
                    ]
                }];
            } else {
                payload.contents = [{ parts: [{ text: userQuery }] }];
            }

            const result = await callGeminiApiWithBackoff(payload);
            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                throw new Error('AI response was empty or malformed.');
            }

            const parsedJson = JSON.parse(jsonText);

            const newTitle = parsedJson.title ? parsedJson.title.slice(0, MAX_TITLE_LENGTH) : resultItem.metadata.title;
            resultItem.metadata.title = newTitle;
            
            resultItem.metadata.description = parsedJson.description ? parsedJson.description.slice(0, 200) : 'Generated Description...';
            
            let rawKeywords = Array.isArray(parsedJson.keywords) ? parsedJson.keywords : [];
            rawKeywords = rawKeywords.flatMap(k => k.includes(',') ? k.split(',').map(s => s.trim()) : [k.trim()]);
            resultItem.metadata.keywords = [...new Set(rawKeywords.filter(k => k.length > 0).map(k => k.toLowerCase()))].slice(0, 49);
        }
        
        window.generateMetadata = async function() {
            if (state.files.length === 0) return;

            elements.analyzeBtn.disabled = true;
            elements.clearBtn.disabled = true;
            elements.spinner.classList.remove('hidden');
            elements.analyzeText.textContent = `Analyzing 1 of ${state.files.length}...`;
            elements.initialOutputPlaceholder.classList.add('hidden');

            for (let i = 0; i < state.files.length; i++) {
                let resultItem = state.results[i];
                const file = resultItem.file;
                
                elements.analyzeText.textContent = `Analyzing ${i + 1} of ${state.files.length} (${file.name})...`;
                resultItem.status = 'processing';
                renderOutput();

                try {
                    await generateSingleMetadata(resultItem);
                    resultItem.status = 'complete';
                    showStatus(`Metadata generated for ${file.name}.`, 'success');
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    resultItem.status = 'error';
                    resultItem.metadata.title = `ERROR: ${file.name}`;
                    resultItem.metadata.description = error.message.slice(0, 190);
                    resultItem.metadata.keywords = ['error', 'failed', 'processing'];
                    showStatus(`Failed to generate metadata for ${file.name}.`, 'error');
                }
                renderOutput();
            }

            elements.analyzeBtn.disabled = false;
            elements.clearBtn.disabled = false;
            elements.spinner.classList.add('hidden');
            elements.analyzeText.textContent = 'Batch Complete! Generate Again?';
            showStatus('Batch metadata generation finished.', 'success');
        }
        
        // --- GEMINI FEATURES ---

        window.optimizeKeywords = async function(id) {
            const resultItem = state.results.find(r => r.id === id);
            if (!resultItem || resultItem.status !== 'complete') return;

            const keywordsBtn = document.getElementById(`keywords-opt-btn-${id}`);
            keywordsBtn.disabled = true;
            keywordsBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing...';
            
            try {
                const systemPrompt = "You are an expert Adobe Stock SEO professional. Based on the provided metadata, generate 10 unique, relevant, and commercially valuable LONG-TAIL keywords. Do NOT repeat any keywords present in the input list. Respond only with a JSON array of strings.";
                
                const userQuery = `Original Title: "${resultItem.metadata.title}"\nOriginal Description: "${resultItem.metadata.description}"\nExisting Keywords: ${resultItem.metadata.keywords.join(', ')}\n\nGenerate 10 new, unique, long-tail keywords for this asset.`;

                const keywordSchema = {
                    type: "OBJECT",
                    properties: {
                        "extra_keywords": { 
                            "type": "ARRAY", 
                            "items": { "type": "STRING" },
                            "description": "10 unique long-tail keywords."
                        }
                    },
                    "propertyOrdering": ["extra_keywords"]
                };

                const payload = {
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: keywordSchema
                    },
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userQuery }] }]
                };

                const result = await callGeminiApiWithBackoff(payload);
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                const parsedJson = JSON.parse(jsonText);
                
                let extraKeywords = Array.isArray(parsedJson.extra_keywords) ? parsedJson.extra_keywords : [];
                extraKeywords = extraKeywords.map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
                
                const existingKeywords = new Set(resultItem.metadata.keywords);
                extraKeywords = extraKeywords.filter(k => !existingKeywords.has(k)).slice(0, 10);
                
                resultItem.extras.keywords = extraKeywords;
                showStatus(`10 long-tail keywords suggested for ${resultItem.file.name}.`, 'success');

            } catch (error) {
                console.error("Keyword Optimization Error:", error);
                resultItem.extras.keywords = [`Error: ${error.message.slice(0, 50)}...`];
                showStatus(`Failed to generate long-tail keywords for ${resultItem.file.name}.`, 'error');
            } finally {
                keywordsBtn.disabled = false;
                keywordsBtn.innerHTML = '✨ Get 10 Long-Tail Keywords';
                renderOutput();
            }
        }
        
        window.optimizeTitles = async function(id) {
            const resultItem = state.results.find(r => r.id === id);
            if (!resultItem || resultItem.status !== 'complete') return;

            const titlesBtn = document.getElementById(`titles-opt-btn-${id}`);
            titlesBtn.disabled = true;
            titlesBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing...';
            
            try {
                const systemPrompt = "You are an expert Adobe Stock content writer. Generate three alternative titles for a stock asset: one Short (<100 chars), one Emotive, and one Trend-Focused. The titles must be in Title Case and highly descriptive. Respond only with a JSON array of objects matching the provided schema.";
                
                const userQuery = `Original Title: "${resultItem.metadata.title}"\nDescription: "${resultItem.metadata.description}"\n\nGenerate 3 alternative titles.`;

                const titleSchema = {
                    type: "OBJECT",
                    properties: {
                        "alternatives": { 
                            "type": "ARRAY", 
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "type": { "type": "STRING", "description": "Short, Emotive, or Trend-Focused" },
                                    "title": { "type": "STRING", "description": "The suggested alternative title." }
                                }
                            }
                        }
                    },
                    "propertyOrdering": ["alternatives"]
                };

                const payload = {
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: titleSchema
                    },
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userQuery }] }]
                };

                const result = await callGeminiApiWithBackoff(payload);
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                const parsedJson = JSON.parse(jsonText);
                
                let alternativeTitles = Array.isArray(parsedJson.alternatives) ? parsedJson.alternatives : [];
                
                resultItem.extras.titles = alternativeTitles.map(item => ({
                    type: item.type ? item.type.slice(0, 20) : 'Alternative',
                    title: item.title ? item.title.slice(0, 190) : 'Title Suggestion'
                }));

                showStatus(`3 title alternatives suggested for ${resultItem.file.name}.`, 'success');

            } catch (error) {
                console.error("Title Optimization Error:", error);
                resultItem.extras.titles = [{ type: 'Error', title: error.message.slice(0, 190) }];
                showStatus(`Failed to generate title alternatives for ${resultItem.file.name}.`, 'error');
            } finally {
                titlesBtn.disabled = false;
                titlesBtn.innerHTML = '✨ Suggest 3 Title Alternatives';
                renderOutput();
            }
        }
        
        function sanitizeTitleForFilename(title, maxLength = 100) {
            let cleanTitle = title.replace(/[^a-zA-Z0-9\-_ ]/g, '').trim();
            cleanTitle = cleanTitle.replace(/ /g, '_');
            return cleanTitle.slice(0, maxLength);
        }


        window.createZipAndDownload = async function() {
            const completedResults = state.results.filter(r => r.status === 'complete');
            if (completedResults.length === 0) {
                showStatus('No completed files ready for download.', 'error');
                return;
            }

            elements.downloadZipBtn.disabled = true;
            elements.zipSpinner.classList.remove('hidden');
            elements.zipButtonText.textContent = 'Creating ZIP... Please wait.';

            const zip = new JSZip();

            try {
                await Promise.all(completedResults.map(async (item) => {
                    const title = item.metadata.title;
                    const extension = item.file.name.substring(item.file.name.lastIndexOf('.'));
                    
                    const cleanTitle = sanitizeTitleForFilename(title); 
                    
                    const newFileName = `${cleanTitle}${extension}`;
                    zip.file(newFileName, item.file);
                }));

                const zipBlob = await zip.generateAsync({ type: "blob" });

                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `AdobeStock_Renamed_Batch_${date}.zip`;
                
                const link = document.createElement("a");
                link.href = URL.createObjectURL(zipBlob);
                link.download = filename;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus('ZIP download started successfully! Contains renamed assets.', 'success');

            } catch (error) {
                console.error("ZIP Creation Error:", error);
                showStatus(`Failed to create ZIP archive: ${error.message}`, 'error');
            } finally {
                elements.downloadZipBtn.disabled = false;
                elements.zipSpinner.classList.add('hidden');
                elements.zipButtonText.textContent = `Download ZIP (${completedResults.length} files)`;
                renderOutput();
            }
        }

        function csvEscape(value) {
            if (value === null || value === undefined) return "";
            let str = String(value);
            str = str.replace(/"/g, '""'); 
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str}"`;
            }
            return str;
        }

        window.downloadCsv = function() {
            const completedResults = state.results.filter(r => r.status === 'complete');
            if (completedResults.length === 0) {
                showStatus('No completed files ready for CSV download.', 'error');
                return;
            }
            
            elements.downloadCsvBtn.disabled = true;

            try {
                const headers = ['Filename', 'Title', 'Description', 'Keywords', 'Extra Keywords']; 
                let csvContent = headers.map(csvEscape).join(',') + '\n';

                completedResults.forEach(item => {
                    const title = item.metadata.title;
                    const extension = item.file.name.substring(item.file.name.lastIndexOf('.'));
                    
                    const newFileName = sanitizeTitleForFilename(title) + extension;
                    
                    const keywordsString = item.metadata.keywords.join(', ');
                    const extraKeywordsString = item.extras.keywords.join(', ');

                    const row = [
                        newFileName,
                        item.metadata.title,
                        item.metadata.description,
                        keywordsString,
                        extraKeywordsString
                    ];

                    csvContent += row.map(csvEscape).join(',') + '\n';
                });

                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `AdobeStock_Metadata_${date}.csv`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showStatus('CSV download started successfully!', 'success');
                } else {
                    showStatus('Your browser does not support CSV download.', 'error');
                }
            } catch (error) {
                console.error("CSV Creation Error:", error);
                showStatus(`Failed to create CSV file: ${error.message}`, 'error');
            } finally {
                elements.downloadCsvBtn.disabled = false;
            }
        }
        
        window.clearAll = function() {
            elements.fileInput.value = '';
            elements.fileNameDisplay.textContent = 'Click or drag files here (Max 25)';
            elements.analyzeBtn.disabled = true;
            elements.clearBtn.disabled = true;
            elements.analysisMethod.textContent = '';
            
            clearPreview();
            
            showStatus('All files and results cleared.', 'info');
        }


        // --- UI RENDERING AND INTERACTIONS ---
        
        window.toggleResult = function(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.add('rotate-180');
            }
        }

        function createResultHtml(result) {
            const { file, metadata, status, id, thumbnail, extras } = result;
            
            let statusText = '';
            let statusColor = 'text-gray-500';
            let bgColor = 'bg-gray-50';

            if (status === 'complete') {
                statusText = 'Completed'; 
                statusColor = 'text-green-700';
                bgColor = 'bg-green-50';
            } else if (status === 'processing') {
                statusText = 'Processing...'; 
                statusColor = 'text-yellow-700';
                bgColor = 'bg-yellow-50';
            } else if (status === 'pending') {
                statusText = 'Incomplete';
                statusColor = 'text-yellow-700';
                bgColor = 'bg-yellow-50';
            } else if (status === 'error') {
                statusText = 'Error';
                statusColor = 'text-red-700';
                bgColor = 'bg-red-50';
            }
            
            const isExpanded = status === 'processing' || status === 'error' || status === 'complete'; 
            
            const allKeywords = [...metadata.keywords.map(k => ({ tag: k, type: 'base' })), 
                                 ...extras.keywords.map(k => ({ tag: k, type: 'extra' }))];

            const keywordsList = allKeywords.map(item => 
                `<span class="keyword-pill ${item.type === 'extra' ? 'keyword-extra' : ''}">${item.tag}</span>`
            ).join('');

            const alternativeTitlesList = extras.titles.map(item => `
                <div class="flex items-center space-x-2 text-sm">
                    <span class="font-bold text-blue-600 w-28 flex-shrink-0">${item.type}:</span>
                    <span class="text-gray-700 truncate">${item.title}</span>
                    <button onclick="copyRawTextToClipboard('${item.title.replace(/'/g, "\\'")}', this)" class="copy-btn px-2 py-1 text-xs text-gray-600 rounded" title="Copy Title">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                    </button>
                </div>
            `).join('');

            const thumbnailHtml = `
                <img src="${thumbnail}" 
                    alt="File thumbnail or icon" 
                    class="preview-thumbnail"
                    onerror="this.onerror=null; this.src='${getFileIcon('generic')}';"
                />
            `;

            return `
                <div id="result-${id}" class="result-item ${bgColor} p-4 rounded-lg border border-200 shadow-sm transition-all duration-300">
                    <div class="flex justify-between items-start cursor-pointer" onclick="toggleResult('${id}')">
                        <div class="flex items-start space-x-4 flex-1 min-w-0">
                            ${thumbnailHtml}
                            <div class="flex-1 min-w-0">
                                <span class="font-bold text-lg text-gray-800 block truncate">${file.name}</span>
                                <span class="text-sm font-semibold ${statusColor} block mt-1">${statusText}</span>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-500 transform transition-transform flex-shrink-0 ml-2 ${isExpanded ? '' : 'rotate-180'}" id="icon-${id}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <div id="content-${id}" class="mt-4 space-y-4 ${isExpanded ? '' : 'hidden'}">
                        <!-- Editable Title -->
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500">AI Title</label>
                                <span class="edit-indicator">✎ Editable</span>
                            </div>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="title-input-${id}" 
                                    value="${metadata.title.replace(/"/g, '&quot;')}"
                                    onchange="updateTitle('${id}', this.value)"
                                    class="editable-input w-full text-sm font-medium text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded focus:ring-2 focus:ring-indigo-500"
                                    maxlength="190"
                                />
                                <button onclick="copyDynamicToClipboard('title-input-${id}', this)" class="copy-btn absolute right-0 top-0 h-full px-3 text-gray-600 rounded-r-lg" title="Copy Title">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${metadata.title.length}/190 characters</p>
                        </div>

                        <!-- Editable Description -->
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500">Description</label>
                                <span class="edit-indicator">✎ Editable</span>
                            </div>
                            <div class="relative">
                                <textarea 
                                    id="desc-input-${id}"
                                    onchange="updateDescription('${id}', this.value)"
                                    class="editable-textarea w-full text-sm text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded resize-none focus:ring-2 focus:ring-indigo-500"
                                    rows="2"
                                    maxlength="200"
                                >${metadata.description}</textarea>
                                <button onclick="copyDynamicToClipboard('desc-input-${id}', this)" class="copy-btn absolute right-0 top-0 h-10 w-10 text-gray-600 rounded-tr-lg" title="Copy Description">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${metadata.description.length}/200 characters</p>
                        </div>

                        <!-- Editable Keywords -->
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500">Keywords (${metadata.keywords.length} base tags)</label>
                                <span class="edit-indicator">✎ Editable</span>
                            </div>
                            <div class="relative">
                                <textarea 
                                    id="keywords-input-${id}"
                                    onchange="updateKeywords('${id}', this.value)"
                                    class="editable-textarea w-full text-sm text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded resize-none focus:ring-2 focus:ring-indigo-500"
                                    rows="3"
                                    placeholder="Enter keywords separated by commas"
                                >${metadata.keywords.join(', ')}</textarea>
                                <button onclick="copyDynamicToClipboard('keywords-input-${id}', this)" class="copy-btn absolute right-0 top-0 h-10 w-10 text-gray-600 rounded-tr-lg" title="Copy Keywords">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Comma-separated tags</p>
                            
                            <!-- Visual keyword pills display -->
                            ${allKeywords.length > 0 ? `
                                <div class="mt-2 pt-2 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-1">Preview (${allKeywords.length} total):</p>
                                    <div class="text-xs max-h-20 overflow-y-auto">${keywordsList}</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Optimization Section -->
                        <div class="pt-4 mt-4 border-t border-gray-200 space-y-3">
                            <label class="block text-sm font-bold text-gray-800">Metadata Optimizations (Gemini LLM)</label>
                            
                            <button id="keywords-opt-btn-${id}" onclick="optimizeKeywords('${id}')" 
                                class="w-full text-sm font-semibold bg-indigo-100 text-indigo-700 py-2 rounded-lg hover:bg-indigo-200 transition duration-150 disabled:opacity-50 flex items-center justify-center">
                                ✨ Get 10 Long-Tail Keywords
                            </button>

                            <div id="extra-keywords-display-${id}" class="bg-white p-2 rounded-lg border border-dashed border-indigo-300 ${extras.keywords.length > 0 ? '' : 'hidden'}">
                                <p class="text-xs font-semibold text-indigo-700 mb-1">Suggested Long-Tail Keywords:</p>
                                <div class="text-xs">${extras.keywords.map(tag => `<span class="keyword-pill keyword-extra">${tag}</span>`).join('')}</div>
                            </div>
                            
                            <button id="titles-opt-btn-${id}" onclick="optimizeTitles('${id}')" 
                                class="w-full text-sm font-semibold bg-indigo-100 text-indigo-700 py-2 rounded-lg hover:bg-indigo-200 transition duration-150 disabled:opacity-50 flex items-center justify-center">
                                ✨ Suggest 3 Title Alternatives
                            </button>

                            <div id="alt-titles-display-${id}" class="bg-white p-3 rounded-lg border border-dashed border-indigo-300 space-y-1 ${extras.titles.length > 0 ? '' : 'hidden'}">
                                <p class="text-xs font-semibold text-indigo-700 mb-2">Alternative Title Suggestions:</p>
                                ${alternativeTitlesList}
                            </div>

                        </div>

                    </div>
                </div>
            `;
        }
        
        function renderOutput() {
            elements.resultsCount.textContent = state.files.length;
            elements.resultsContainer.innerHTML = '';
            
            elements.clearBtn.disabled = state.files.length === 0;

            const completedCount = state.results.filter(r => r.status === 'complete').length;
            elements.downloadReadyCount.textContent = completedCount;
            elements.downloadZipBtn.disabled = completedCount === 0;
            elements.downloadCsvBtn.disabled = completedCount === 0;

            if (state.results.length === 0) {
                elements.initialOutputPlaceholder.classList.remove('hidden');
            } else {
                elements.initialOutputPlaceholder.classList.add('hidden');
                state.results.forEach(result => {
                    elements.resultsContainer.insertAdjacentHTML('beforeend', createResultHtml(result));
                });
            }
        }

        window.copyDynamicToClipboard = function(elementId, button) {
            const element = document.getElementById(elementId);
            const textToCopy = element.value || element.textContent;
            
            copyTextLogic(textToCopy, button);
        }

        window.copyRawTextToClipboard = function(textToCopy, button) {
            copyTextLogic(textToCopy, button);
        }

        function copyTextLogic(textToCopy, button) {
             if (!textToCopy) {
                showStatus(`Field is empty.`, 'error');
                return;
            }
            
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = textToCopy;
            tempTextarea.style.position = 'fixed'; 
            tempTextarea.style.opacity = '0';
            document.body.appendChild(tempTextarea);
            
            tempTextarea.select();
            tempTextarea.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showStatus(`Copied to clipboard!`, 'success');
                
                button.innerHTML = `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                setTimeout(() => {
                    button.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>`;
                    if(button.id && button.id.startsWith('keywords-opt-btn')) {
                         button.innerHTML = '✨ Get 10 Long-Tail Keywords';
                    } else if (button.id && button.id.startsWith('titles-opt-btn')) {
                         button.innerHTML = '✨ Suggest 3 Title Alternatives';
                    }
                }, 1500);

            } catch (err) {
                console.error('Copy failed:', err);
                showStatus('Copy failed. Please manually select and copy.', 'error');
            } finally {
                document.body.removeChild(tempTextarea);
            }
        }


        function showStatus(message, type) {
            elements.statusMessage.textContent = message;
            elements.statusMessage.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-gray-800', 'bg-green-600');
            elements.statusMessage.classList.add('opacity-100');
            
            if (type === 'success') {
                elements.statusMessage.classList.add('bg-green-600');
            } else if (type === 'error') {
                elements.statusMessage.classList.add('bg-red-500');
            } else {
                elements.statusMessage.classList.add('bg-gray-800');
            }

            setTimeout(() => {
                elements.statusMessage.classList.remove('opacity-100');
                elements.statusMessage.classList.add('opacity-0');
                setTimeout(() => {
                    elements.statusMessage.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderOutput();
        });
    </script>
</body>
</html>
