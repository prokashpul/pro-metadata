<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro Stock Metadata Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --adobe-red: #FA0000;
            --adobe-red-dark: #D60000;
            --shutterstock-blue: #0066CC;
            --freepik-blue: #1273EB;
        }
        
        /* Light Mode Colors */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            padding-top: 4.5rem;
            padding-bottom: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Mode Colors */
        body.dark-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body.dark-mode .card {
            background-color: #1e293b;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background-color: var(--adobe-red);
            transition: background-color 0.15s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: var(--adobe-red-dark);
        }
        .btn-primary:active {
            transform: scale(0.99);
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            transition: background-color 0.15s, transform 0.1s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        
        body.dark-mode .btn-secondary {
            background-color: #334155;
            color: #cbd5e1;
        }
        
        body.dark-mode .btn-secondary:hover {
            background-color: #475569;
        }
        
        .file-input-label {
            cursor: pointer;
            border: 3px dashed #cbd5e1;
            text-align: center;
            border-radius: 0.75rem;
            background-color: #fef2f2;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-input-label:hover {
            border-color: var(--adobe-red);
            background-color: #fee2e2;
        }
        
        body.dark-mode .file-input-label {
            background-color: #1e293b;
            border-color: #475569;
        }
        
        body.dark-mode .file-input-label:hover {
            border-color: var(--adobe-red);
            background-color: #334155;
        }
        
        .copy-btn {
            background-color: #f1f5f9;
            transition: background-color 0.1s;
        }
        .copy-btn:hover {
            background-color: #e2e8f0;
        }
        .copy-btn:active {
            transform: scale(0.99);
        }
        
        body.dark-mode .copy-btn {
            background-color: #334155;
        }
        
        body.dark-mode .copy-btn:hover {
            background-color: #475569;
        }
        
        .keyword-pill {
            display: inline-flex;
            padding: 0.3rem 0.75rem;
            margin: 0.25rem;
            background-color: #FA0000;
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .keyword-extra {
             background-color: #3b82f6;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Preview thumbnail size */
        .preview-thumbnail {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body.dark-mode .preview-thumbnail {
            border-color: #475569;
        }
        
        /* Platform badges */
        .platform-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.25rem;
        }
        
        .platform-adobe {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        
        .platform-shutterstock {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        
        .platform-freepik {
            background-color: #E0E7FF;
            color: #3730A3;
        }
        
        body.dark-mode .platform-adobe {
            background-color: #7F1D1D;
            color: #FEE2E2;
        }
        
        body.dark-mode .platform-shutterstock {
            background-color: #1E3A8A;
            color: #DBEAFE;
        }
        
        body.dark-mode .platform-freepik {
            background-color: #3730A3;
            color: #E0E7FF;
        }
        
        /* Platform checkbox styling */
        .platform-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .platform-checkbox:checked {
            background-color: #6366f1;
            border-color: #6366f1;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        body.dark-mode .platform-checkbox {
            border-color: #475569;
            background-color: #334155;
        }
        
        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        body.dark-mode #main-header {
            background-color: #1e293b;
            border-bottom-color: #334155;
        }
        
        #apiModal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        /* Dark mode for modal backdrop */
        body.dark-mode #apiModal {
            background-color: rgba(0, 0, 0, 0.85);
        }
        
        /* Footer Styles */
        #main-footer {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            margin-top: 4rem;
            transition: background 0.3s ease;
        }
        
        body.dark-mode #main-footer {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        }
        
        .footer-link {
            color: #cbd5e1;
            transition: color 0.2s;
        }
        .footer-link:hover {
            color: var(--adobe-red);
        }
        .tech-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            font-size: 0.75rem;
            margin: 0.25rem;
        }
        
        /* Dark mode toggle button */
        .theme-toggle {
            background-color: #f1f5f9;
            transition: background-color 0.2s;
        }
        
        .theme-toggle:hover {
            background-color: #e2e8f0;
        }
        
        body.dark-mode .theme-toggle {
            background-color: #334155;
        }
        
        body.dark-mode .theme-toggle:hover {
            background-color: #475569;
        }
        
        /* Editable field styles */
        .editable-input,
        .editable-textarea {
            transition: all 0.2s ease;
            background-color: transparent;
        }
        
        .editable-input:focus,
        .editable-textarea:focus {
            outline: none;
            background-color: #f8fafc;
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .editable-input:focus,
        body.dark-mode .editable-textarea:focus {
            background-color: #0f172a;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .edit-indicator {
            font-size: 0.65rem;
            color: #6366f1;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Character count warning styles */
        .char-warning {
            color: #dc2626;
            font-weight: 600;
        }
        
        .char-success {
            color: #16a34a;
            font-weight: 600;
        }
        
        /* Text color adjustments for dark mode */
        body.dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }
        
        body.dark-mode .text-gray-600 {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .text-gray-500 {
            color: #64748b !important;
        }
        
        body.dark-mode .text-gray-400 {
            color: #475569 !important;
        }
        
        /* Border colors for dark mode */
        body.dark-mode .border-gray-200 {
            border-color: #334155 !important;
        }
        
        body.dark-mode .border-gray-300 {
            border-color: #475569 !important;
        }
        
        body.dark-mode .border-gray-700 {
            border-color: #1e293b !important;
        }
        
        /* Background colors for dark mode */
        body.dark-mode .bg-white {
            background-color: #1e293b !important;
        }
        
        body.dark-mode .bg-gray-50 {
            background-color: #334155 !important;
        }
        
        body.dark-mode .bg-gray-100 {
            background-color: #475569 !important;
        }
        
        body.dark-mode .bg-green-50 {
            background-color: #14532d !important;
        }
        
        body.dark-mode .bg-yellow-50 {
            background-color: #422006 !important;
        }
        
        body.dark-mode .bg-red-50 {
            background-color: #450a0a !important;
        }
        
        /* Input fields in dark mode */
        body.dark-mode input[type="text"],
        body.dark-mode input[type="checkbox"],
        body.dark-mode textarea {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        body.dark-mode input[type="text"]:focus,
        body.dark-mode textarea:focus {
            border-color: #6366f1;
            background-color: #1e293b;
        }
        
        /* Platform tabs */
        .platform-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .platform-tab:hover {
            background-color: #f1f5f9;
        }
        
        .platform-tab.active {
            border-bottom-color: #6366f1;
            font-weight: 600;
        }
        
        body.dark-mode .platform-tab:hover {
            background-color: #334155;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- FIXED HEADER -->
    <header id="main-header" class="p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                 <h1 class="text-2xl font-extrabold text-gray-900">
                    <span style="color:var(--adobe-red);">MicroStock</span> Metadata Pro
                </h1>
                
            </div>
            
            <div class="flex items-center space-x-2">
                <!-- Dark Mode Toggle Button -->
                <button onclick="toggleDarkMode()" 
                    class="theme-toggle p-2 rounded-lg transition duration-150" 
                    title="Toggle dark mode"
                    aria-label="Toggle dark mode">
                    <svg id="sunIcon" class="w-5 h-5 text-gray-700 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moonIcon" class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                
                <button onclick="showApiModal()" 
                    class="px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.996.608 2.245.54 3.14-.078z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="hidden sm:inline">API Settings</span>
                    <span class="inline sm:hidden">API</span>
                </button>
            </div>
        </div>
    </header>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-8">
        
        <!-- Main Application Description -->
        <header class="text-center mb-12">
            <p class="text-xl text-gray-600 mt-3">
                Generate platform-optimized metadata for Adobe Stock, Shutterstock, and Freepik simultaneously.
            </p>
        </header>


        <div class="grid grid-cols-1 lg:col-span-3 gap-8">

            <!-- UPLOAD AND CONTROLS (Left Column) -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">1. Upload Files</h2>
                    
                    <!-- File Preview Area -->
                    <div id="filePreviewContainer" class="mb-4 w-full h-24 flex flex-col items-center justify-center">
                        <svg id="filePlaceholderIcon" class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        <p id="filePreviewText" class="text-gray-600 font-semibold">No files selected.</p>
                    </div>
                    
                    <div class="input-group mb-6">
                        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.ai,.eps,.mp4,.mov" class="hidden" onchange="handleFileChange(this)" multiple>
                        <label for="fileInput" class="file-input-label block p-6 sm:p-10">
                            <span class="text-lg font-semibold block mb-1 text-gray-700" id="fileNameDisplay">Click or drag files here (Max 25)</span>
                            <span class="text-sm text-gray-500 block">JPG, PNG, EPS, AI, MOV, MP4 supported.</span>
                        </label>
                    </div>
                    
                    <!-- Platform Selection -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">Select Target Platforms:</h3>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-100 transition">
                                <input type="checkbox" id="platformAdobe" class="platform-checkbox" checked onchange="updatePlatformSelection()">
                                <span class="platform-badge platform-adobe">Adobe Stock</span>
                                <span class="text-xs text-gray-500 ml-auto">49 keywords | Title: 150-190 chars </span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-100 transition">
                                <input type="checkbox" id="platformShutterstock" class="platform-checkbox" checked onchange="updatePlatformSelection()">
                                <span class="platform-badge platform-shutterstock">Shutterstock</span>
                                <span class="text-xs text-gray-500 ml-auto">50 keywords | Title: 145-200 chars </span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-100 transition">
                                <input type="checkbox" id="platformFreepik" class="platform-checkbox" checked onchange="updatePlatformSelection()">
                                <span class="platform-badge platform-freepik">Freepik</span>
                                <span class="text-xs text-gray-500 ml-auto">50 keywords | Title: 75-100 chars</span>
                            </label>
                        </div>
                        <p id="platformWarning" class="text-xs text-amber-600 mt-2 hidden">⚠️ Please select at least one platform</p>
                    </div>

                    <div class="space-y-3">
                        <button id="analyzeBtn" onclick="generateMetadata()" 
                            class="btn-primary w-full text-white py-3 rounded-lg font-bold flex items-center justify-center disabled:opacity-50" disabled>
                            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="analyzeText">Generate Metadata for Batch</span>
                        </button>
                        
                        <button id="clearBtn" onclick="clearAll()" 
                            class="btn-secondary w-full py-3 rounded-lg font-bold flex items-center justify-center disabled:opacity-50" disabled>
                            Clear All Files & Results
                        </button>
                        
                    </div>
                    <p id="analysisMethod" class="text-xs text-center text-gray-500 mt-3"></p>
                </div>
            </div>

            <!-- METADATA OUTPUT (Right Columns) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">2. Generated Metadata (<span id="resultsCount">0</span> Files)</h2>
                    
                    <!-- Grouped Download Buttons -->
                    <div class="flex flex-wrap gap-2 mb-4"> 
                        <button id="downloadZipAdobe" onclick="createZipAndDownload('adobe')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-white rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center justify-center" 
                            style="background-color: var(--adobe-red);" disabled>
                            📦 Adobe Stock ZIP
                        </button>
                        
                        <button id="downloadZipShutterstock" onclick="createZipAndDownload('shutterstock')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-white rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center justify-center" 
                            style="background-color: var(--shutterstock-blue);" disabled>
                            📦 Shutterstock ZIP
                        </button>
                        
                        <button id="downloadZipFreepik" onclick="createZipAndDownload('freepik')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-white rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center justify-center" 
                            style="background-color: var(--freepik-blue);" disabled>
                            📦 Freepik ZIP
                        </button>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <button id="downloadCsvAll" onclick="downloadCsv('all')" 
                            class="flex-1 px-3 py-2 text-sm font-semibold text-gray-800 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50" disabled>
                            📊 Download All CSVs
                        </button>
                    </div>
                    
                    <!-- Container for all results -->
                    <div id="resultsContainer" class="space-y-4">
                        <p id="initialOutputPlaceholder" class="text-gray-400 italic">Upload and analyze files to see results here.</p>
                        <!-- Dynamic file results will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Message Box -->
        <div id="statusMessage" class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50" role="alert">
            <!-- Messages appear here -->
        </div>

    </div>
    
    <!-- FOOTER SECTION -->
    <footer id="main-footer" class="mt-16 py-8 border-t border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                
                <!-- Column 1: Branding & Description -->
                <div class="space-y-3">
                    <h3 class="text-lg font-bold text-white">
                        <span style="color:var(--adobe-red);">MicroStock</span> Metadata Pro
                    </h3>
                    <p class="text-sm text-gray-400">
                        AI-powered batch metadata generation tool for Adobe Stock, Shutterstock, and Freepik. Platform-specific optimization with intelligent SEO suggestions.
                    </p>
                    <p class="text-xs text-gray-500">
                        Version 2.0.0 | Updated 2025
                    </p>
                </div>

                <!-- Column 2: Tech Stack -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider">Powered By</h4>
                    <div class="flex flex-wrap">
                        <span class="tech-badge">🤖 Google Gemini 2.5</span>
                        <span class="tech-badge">⚡ Tailwind CSS</span>
                        <span class="tech-badge">📦 JSZip</span>
                        <span class="tech-badge">🎨 Inter Font</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Built with cutting-edge AI and modern web technologies.
                    </p>
                </div>

                <!-- Column 3: Links & Info -->
                <div class="space-y-3">
                    <h4 class="text-sm font-bold text-white uppercase tracking-wider">Supported Platforms</h4>
                    <ul class="space-y-2 text-sm">
                        <li>
                            <a href="https://contributor.stock.adobe.com/" target="_blank" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Adobe Stock</span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.shutterstock.com/contributor" target="_blank" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Shutterstock</span>
                            </a>
                        </li>
                        <li>
                            <a href="https://contributor.freepik.com" target="_blank" class="footer-link flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                <span>Freepik</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="pt-6 border-t border-gray-700 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <p class="text-xs text-gray-500">
                    © 2025 <span style="color:var(--adobe-red);">MicroStock</span> Metadata Pro. Not officially affiliated with Adobe, Shutterstock, or Freepik.
                </p>
                <div class="flex items-center space-x-4 text-xs text-gray-500">
                    <span class="flex items-center space-x-1">
                        <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span>Client-side Processing</span>
                    </span>
                    <span class="flex items-center space-x-1">
                        <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                        <span>Privacy Focused</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- API KEY MODAL -->
    <div id="apiModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 invisible opacity-0">
        <div class="card w-full max-w-lg p-6 sm:p-8 transform transition-all duration-300 scale-95">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-gray-900">API Settings</h3>
                <button onclick="hideApiModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <p class="text-sm text-gray-600 mb-4">
                Enter your Google Gemini API key to enable metadata generation.
            </p>

            <form id="apiForm" onsubmit="saveApiKeys(event)">
                <div class="space-y-4">
                    <label for="geminiApiKey" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="text" id="geminiApiKey" name="geminiApiKey" placeholder="AIzaSy..."
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                
                <div id="apiStatusMessage" class="mt-4 text-xs font-medium text-center text-indigo-600">
                    <!-- Status of the API key goes here -->
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideApiModal()" class="btn-secondary px-4 py-2 rounded-lg font-semibold">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150">
                        Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // --- Dark Mode Functionality ---
        const DARK_MODE_STORAGE = 'multiPlatformStock_darkMode';
        
        function initDarkMode() {
            const savedDarkMode = localStorage.getItem(DARK_MODE_STORAGE);
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                updateDarkModeIcons(true);
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem(DARK_MODE_STORAGE, isDark);
            updateDarkModeIcons(isDark);
        }
        
        function updateDarkModeIcons(isDark) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (isDark) {
                sunIcon.classList.remove('hidden');
                sunIcon.classList.add('text-gray-300');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                moonIcon.classList.add('text-gray-700');
            }
        }
        
        // Initialize dark mode on page load
        initDarkMode();
        
        // --- Platform Configuration ---
        const PLATFORM_CONFIGS = {
            adobe: {
                name: 'Adobe Stock',
                titleMax: 190,
                titleMin: 150,
                descMax: 200,
                keywordsMax: 49,
                systemPrompt: "You are a world-class Adobe Stock SEO expert. Generate metadata optimized for Adobe Stock's algorithm. Title must be 150-190 characters in Title Case (REQUIRED - strictly enforce this range). Description must be engaging (max 200 chars). Generate exactly 49 unique, high-value, commercially relevant keywords."
            },
            shutterstock: {
                name: 'Shutterstock',
                titleMax: 200,
                titleMin: 145,
                descMax: 200,
                keywordsMax: 50,
                systemPrompt: "You are a Shutterstock SEO specialist. Generate metadata optimized for Shutterstock's search algorithm. Title must be 145-200 characters in Title Case (REQUIRED - strictly enforce this range). Description must be detailed (max 200 chars). Generate exactly 50 unique, relevant keywords with mix of broad and specific terms."
            },
            freepik: {
                name: 'Freepik',
                titleMax: 100,
                titleMin: 75,
                descMax: 200,
                keywordsMax: 50,
                systemPrompt: "You are a Freepik content optimization expert. Generate metadata for Freepik's platform. Title must be 75-100 characters in Title Case (REQUIRED - strictly enforce this range). Description must be informative (max 200 chars). Generate exactly 50 unique keywords focusing on style, theme, and usage."
            }
        };
        
        // --- Core Application Logic & State ---
        const MAX_RETRIES = 3;

        const GEMINI_API_KEY_STORAGE = 'multiPlatformStock_geminiKey';

        const state = {
            files: [],
            results: [], // Each result will have metadata for multiple platforms
            maxFiles: 25,
            userApiKey: localStorage.getItem(GEMINI_API_KEY_STORAGE) || '',
            selectedPlatforms: ['adobe', 'shutterstock', 'freepik'] // Default all selected
        };
        
        function getApiKey() {
            return state.userApiKey || ""; 
        }
        
        // --- Platform Selection ---
        window.updatePlatformSelection = function() {
            const adobe = document.getElementById('platformAdobe').checked;
            const shutterstock = document.getElementById('platformShutterstock').checked;
            const freepik = document.getElementById('platformFreepik').checked;
            
            state.selectedPlatforms = [];
            if (adobe) state.selectedPlatforms.push('adobe');
            if (shutterstock) state.selectedPlatforms.push('shutterstock');
            if (freepik) state.selectedPlatforms.push('freepik');
            
            const warning = document.getElementById('platformWarning');
            if (state.selectedPlatforms.length === 0) {
                warning.classList.remove('hidden');
                document.getElementById('analyzeBtn').disabled = true;
            } else {
                warning.classList.add('hidden');
                if (state.files.length > 0) {
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }
            
            updateDownloadButtons();
        }
        
        function updateDownloadButtons() {
            const completedCount = state.results.filter(r => r.status === 'complete').length;
            
            document.getElementById('downloadZipAdobe').disabled = !state.selectedPlatforms.includes('adobe') || completedCount === 0;
            document.getElementById('downloadZipShutterstock').disabled = !state.selectedPlatforms.includes('shutterstock') || completedCount === 0;
            document.getElementById('downloadZipFreepik').disabled = !state.selectedPlatforms.includes('freepik') || completedCount === 0;
            document.getElementById('downloadCsvAll').disabled = completedCount === 0;
        }

        const elements = {
            fileInput: document.getElementById('fileInput'),
            fileNameDisplay: document.getElementById('fileNameDisplay'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            spinner: document.getElementById('spinner'),
            analyzeText: document.getElementById('analyzeText'),
            statusMessage: document.getElementById('statusMessage'),
            filePreviewContainer: document.getElementById('filePreviewContainer'),
            filePlaceholderIcon: document.getElementById('filePlaceholderIcon'),
            filePreviewText: document.getElementById('filePreviewText'),
            analysisMethod: document.getElementById('analysisMethod'),
            resultsContainer: document.getElementById('resultsContainer'),
            initialOutputPlaceholder: document.getElementById('initialOutputPlaceholder'),
            resultsCount: document.getElementById('resultsCount'),
            clearBtn: document.getElementById('clearBtn'), 
            apiModal: document.getElementById('apiModal'),
            geminiApiKeyInput: document.getElementById('geminiApiKey'),
            apiStatusMessage: document.getElementById('apiStatusMessage'),
        };

        // --- Editable Field Functions ---
        
        window.updateMetadata = function(id, platform, field, value) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem && resultItem.platformMetadata[platform]) {
                if (field === 'keywords') {
                    const keywords = value.split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
                    resultItem.platformMetadata[platform].keywords = [...new Set(keywords)];
                } else {
                    resultItem.platformMetadata[platform][field] = value;
                }
                
                // Update character count display
                if (field === 'title') {
                    updateCharacterCount(id, platform);
                }
            }
        }
        
        // Function to update character count and warning
        function updateCharacterCount(id, platform) {
            const config = PLATFORM_CONFIGS[platform];
            const inputElement = document.getElementById(`title-input-${id}-${platform}`);
            const charCountElement = document.getElementById(`char-count-${id}-${platform}`);
            
            if (inputElement && charCountElement) {
                const length = inputElement.value.length;
                const isValid = length >= config.titleMin && length <= config.titleMax;
                
                charCountElement.textContent = `${length}/${config.titleMax} characters (Required: ${config.titleMin}-${config.titleMax})`;
                
                if (isValid) {
                    charCountElement.classList.remove('char-warning');
                    charCountElement.classList.add('char-success');
                } else {
                    charCountElement.classList.remove('char-success');
                    charCountElement.classList.add('char-warning');
                }
            }
        }

        // --- API Modal Functions ---
        window.showApiModal = function() {
            elements.geminiApiKeyInput.value = state.userApiKey;
            elements.apiStatusMessage.textContent = state.userApiKey ? "Using custom API key." : "Using default environment key.";
            elements.apiModal.classList.remove('invisible', 'opacity-0');
            elements.apiModal.classList.add('opacity-100');
        }

        window.hideApiModal = function() {
            elements.apiModal.classList.remove('opacity-100');
            elements.apiModal.classList.add('invisible', 'opacity-0');
        }

        window.saveApiKeys = function(event) {
            event.preventDefault();
            const newKey = elements.geminiApiKeyInput.value.trim();
            
            if (newKey && newKey.length < 20) {
                 elements.apiStatusMessage.textContent = "Key looks too short. Please check it.";
                 return;
            }

            state.userApiKey = newKey;
            localStorage.setItem(GEMINI_API_KEY_STORAGE, newKey);
            
            if (newKey) {
                 elements.apiStatusMessage.textContent = "Gemini API key saved successfully!";
                 showStatus('Custom Gemini API key saved.', 'success');
            } else {
                 elements.apiStatusMessage.textContent = "Switched back to using the default environment key.";
                 showStatus('Switched to default API key.', 'info');
            }
            
            setTimeout(hideApiModal, 1000);
        }

        // --- Utility Functions ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function getFileIcon(extension) {
            const defaultColor = '#5e5e5e'; 
            let svgPath = '';

            if (extension === 'video' || extension === 'mp4' || extension === 'mov') {
                svgPath = `<path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 10h7a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2a1 1 0 011-1z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else if (extension === 'ai' || extension === 'eps') {
                svgPath = `<path d="M12 20h9M16.5 3.5l-3 3L8 15l-3 3 6-6 3-3 3.5-3.5a2.121 2.121 0 013 3z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else {
                svgPath = `<path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13 2v7h7" stroke="${defaultColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
            }

            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">${svgPath}</svg>`;
            return `data:image/svg+xml;base64,${btoa(svg)}`;
        }
        
        async function getThumbnailData(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png'].includes(extension);
            const isVideo = ['mp4', 'mov'].includes(extension);
            const isVector = ['ai', 'eps'].includes(extension);

            if (isImage) {
                return fileToDataUrl(file);
            } else if (isVideo) {
                return getFileIcon('video');
            } else if (isVector) {
                return getFileIcon(extension);
            } else {
                return getFileIcon('generic');
            }
        }

        function clearPreview() {
            state.files = [];
            state.results = [];

            elements.filePlaceholderIcon.classList.remove('hidden');
            elements.filePlaceholderIcon.innerHTML = `<svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`;
            elements.filePreviewText.textContent = 'No files selected.';

            elements.analyzeText.textContent = 'Generate Metadata for Batch';
            
            renderOutput();
        }

        window.handleFileChange = async function(input) {
            if (input.files.length === 0) {
                elements.fileNameDisplay.textContent = 'Click or drag files here (Max 25)';
                elements.analyzeBtn.disabled = true;
                elements.clearBtn.disabled = true;
                elements.analysisMethod.textContent = '';
                clearPreview();
                return;
            }
            
            const selectedFiles = Array.from(input.files).slice(0, state.maxFiles);
            state.files = selectedFiles;
            
            const filePromises = selectedFiles.map(async (file) => ({
                file,
                status: 'pending',
                platformMetadata: {}, // Will hold metadata for each platform
                id: crypto.randomUUID(),
                thumbnail: await getThumbnailData(file),
                activePlatform: state.selectedPlatforms[0] || 'adobe' // Default active tab
            }));

            state.results = await Promise.all(filePromises);

            elements.fileNameDisplay.textContent = `${state.files.length} file(s) selected.`;
            elements.filePreviewText.textContent = `Ready to process ${state.files.length} file(s).`;
            elements.analyzeBtn.disabled = state.selectedPlatforms.length === 0;
            elements.clearBtn.disabled = false;
            elements.analysisMethod.textContent = `Batch mode for ${state.selectedPlatforms.length} platform(s). Processing ${state.files.length} file(s).`;

            renderOutput();
        }

        async function callGeminiApiWithBackoff(payload, attempt = 0) {
            const currentKey = getApiKey();
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${currentKey}`;
            
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
            if (attempt > 0) await new Promise(resolve => setTimeout(resolve, delay));

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                    throw new Error('Content was blocked due to safety settings.');
                }
                
                return result;

            } catch (error) {
                if (attempt < MAX_RETRIES - 1) {
                    return callGeminiApiWithBackoff(payload, attempt + 1);
                } else {
                    console.error("Gemini API Error after max retries:", error);
                    throw new Error(`Failed to get a response from AI after max attempts: ${error.message}`);
                }
            }
        }

        async function generatePlatformMetadata(resultItem, platform) {
            const file = resultItem.file;
            const extension = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png'].includes(extension);
            
            const config = PLATFORM_CONFIGS[platform];

            let base64Data = '';
            if (isImage) {
                try {
                    base64Data = await fileToBase64(file);
                } catch (e) {
                    throw new Error(`Failed to read image file: ${e.message}`);
                }
            }

            const userQuery = `Generate ${config.name} metadata for this asset (File Type: ${isImage ? 'Image' : extension.toUpperCase()}, Filename: ${file.name}). Focus on commercial value and searchability specific to ${config.name}'s platform. IMPORTANT: Title MUST be between ${config.titleMin}-${config.titleMax} characters.`;

            const metadataSchema = {
                type: "OBJECT",
                properties: {
                    "title": { "type": "STRING" },
                    "description": { "type": "STRING" },
                    "keywords": { "type": "ARRAY", "items": { "type": "STRING" } }
                },
                "propertyOrdering": ["title", "description", "keywords"]
            };

            const payload = {
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: metadataSchema
                },
                systemInstruction: {
                    parts: [{ text: config.systemPrompt }]
                }
            };

            if (base64Data) {
                payload.contents = [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        { inlineData: { mimeType: file.type, data: base64Data } }
                    ]
                }];
            } else {
                payload.contents = [{ parts: [{ text: userQuery }] }];
            }

            const result = await callGeminiApiWithBackoff(payload);
            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                throw new Error('AI response was empty or malformed.');
            }

            const parsedJson = JSON.parse(jsonText);

            // Ensure title meets minimum length requirement
            let title = parsedJson.title || file.name.substring(0, file.name.lastIndexOf('.'));
            
            // If title is too short, pad it; if too long, truncate it
            if (title.length < config.titleMin) {
                // Pad with descriptive text to meet minimum
                const padding = ` - High Quality Stock Content for Commercial Use`;
                title = (title + padding).slice(0, config.titleMax);
            } else if (title.length > config.titleMax) {
                title = title.slice(0, config.titleMax);
            }
            
            const description = parsedJson.description ? parsedJson.description.slice(0, config.descMax) : 'Generated Description...';
            
            let rawKeywords = Array.isArray(parsedJson.keywords) ? parsedJson.keywords : [];
            rawKeywords = rawKeywords.flatMap(k => k.includes(',') ? k.split(',').map(s => s.trim()) : [k.trim()]);
            const keywords = [...new Set(rawKeywords.filter(k => k.length > 0).map(k => k.toLowerCase()))].slice(0, config.keywordsMax);
            
            return { title, description, keywords };
        }
        
        window.generateMetadata = async function() {
            if (state.files.length === 0 || state.selectedPlatforms.length === 0) return;

            elements.analyzeBtn.disabled = true;
            elements.clearBtn.disabled = true;
            elements.spinner.classList.remove('hidden');
            elements.analyzeText.textContent = `Analyzing 1 of ${state.files.length}...`;
            elements.initialOutputPlaceholder.classList.add('hidden');

            for (let i = 0; i < state.files.length; i++) {
                let resultItem = state.results[i];
                const file = resultItem.file;
                
                resultItem.status = 'processing';
                renderOutput();

                try {
                    // Generate metadata for each selected platform
                    for (const platform of state.selectedPlatforms) {
                        elements.analyzeText.textContent = `Analyzing ${i + 1}/${state.files.length} - ${PLATFORM_CONFIGS[platform].name}...`;
                        
                        const metadata = await generatePlatformMetadata(resultItem, platform);
                        resultItem.platformMetadata[platform] = metadata;
                    }
                    
                    resultItem.status = 'complete';
                    showStatus(`Metadata generated for ${file.name} (${state.selectedPlatforms.length} platforms).`, 'success');
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    resultItem.status = 'error';
                    
                    // Set error metadata for all selected platforms
                    state.selectedPlatforms.forEach(platform => {
                        resultItem.platformMetadata[platform] = {
                            title: `ERROR: ${file.name}`,
                            description: error.message.slice(0, 200),
                            keywords: ['error', 'failed', 'processing']
                        };
                    });
                    
                    showStatus(`Failed to generate metadata for ${file.name}.`, 'error');
                }
                renderOutput();
            }

            elements.analyzeBtn.disabled = false;
            elements.clearBtn.disabled = false;
            elements.spinner.classList.add('hidden');
            elements.analyzeText.textContent = 'Batch Complete! Generate Again?';
            showStatus('Batch metadata generation finished.', 'success');
            updateDownloadButtons();
        }
        
        function sanitizeTitleForFilename(title, maxLength = 100) {
            let cleanTitle = title.replace(/[^a-zA-Z0-9\-_ ]/g, '').trim();
            cleanTitle = cleanTitle.replace(/ /g, '_');
            return cleanTitle.slice(0, maxLength);
        }

        window.createZipAndDownload = async function(platform) {
            const completedResults = state.results.filter(r => r.status === 'complete' && r.platformMetadata[platform]);
            if (completedResults.length === 0) {
                showStatus(`No completed files ready for ${PLATFORM_CONFIGS[platform].name} download.`, 'error');
                return;
            }

            const zip = new JSZip();

            try {
                await Promise.all(completedResults.map(async (item) => {
                    const metadata = item.platformMetadata[platform];
                    const title = metadata.title;
                    const extension = item.file.name.substring(item.file.name.lastIndexOf('.'));
                    
                    const cleanTitle = sanitizeTitleForFilename(title); 
                    const newFileName = `${cleanTitle}${extension}`;
                    zip.file(newFileName, item.file);
                }));

                const zipBlob = await zip.generateAsync({ type: "blob" });

                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `${PLATFORM_CONFIGS[platform].name.replace(/\s/g, '_')}_Batch_${date}.zip`;
                
                const link = document.createElement("a");
                link.href = URL.createObjectURL(zipBlob);
                link.download = filename;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus(`ZIP download started for ${PLATFORM_CONFIGS[platform].name}!`, 'success');

            } catch (error) {
                console.error("ZIP Creation Error:", error);
                showStatus(`Failed to create ZIP archive: ${error.message}`, 'error');
            }
        }

        function csvEscape(value) {
            if (value === null || value === undefined) return "";
            let str = String(value);
            str = str.replace(/"/g, '""'); 
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str}"`;
            }
            return str;
        }

        window.downloadCsv = function(mode) {
            const completedResults = state.results.filter(r => r.status === 'complete');
            if (completedResults.length === 0) {
                showStatus('No completed files ready for CSV download.', 'error');
                return;
            }

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');

            if (mode === 'all') {
                // Create separate CSV for each platform
                state.selectedPlatforms.forEach(platform => {
                    const config = PLATFORM_CONFIGS[platform];
                    const headers = ['Filename', 'Title', 'Description', 'Keywords']; 
                    let csvContent = headers.map(csvEscape).join(',') + '\n';

                    completedResults.forEach(item => {
                        if (item.platformMetadata[platform]) {
                            const metadata = item.platformMetadata[platform];
                            const title = metadata.title;
                            const extension = item.file.name.substring(item.file.name.lastIndexOf('.'));
                            
                            const newFileName = sanitizeTitleForFilename(title) + extension;
                            const keywordsString = metadata.keywords.join(', ');

                            const row = [
                                newFileName,
                                metadata.title,
                                metadata.description,
                                keywordsString
                            ];

                            csvContent += row.map(csvEscape).join(',') + '\n';
                        }
                    });

                    const filename = `${config.name.replace(/\s/g, '_')}_Metadata_${date}.csv`;
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    
                    if (link.download !== undefined) { 
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
                
                showStatus(`CSV files downloaded for all ${state.selectedPlatforms.length} platforms!`, 'success');
            }
        }
        
        window.clearAll = function() {
            elements.fileInput.value = '';
            elements.fileNameDisplay.textContent = 'Click or drag files here (Max 25)';
            elements.analyzeBtn.disabled = true;
            elements.clearBtn.disabled = true;
            elements.analysisMethod.textContent = '';
            
            clearPreview();
            updateDownloadButtons();
            
            showStatus('All files and results cleared.', 'info');
        }

        // --- Platform Tab Switching ---
        window.switchPlatformTab = function(id, platform) {
            const resultItem = state.results.find(r => r.id === id);
            if (resultItem) {
                resultItem.activePlatform = platform;
                renderOutput();
            }
        }

        // --- UI RENDERING AND INTERACTIONS ---
        
        window.toggleResult = function(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.add('rotate-180');
            }
        }

        function createResultHtml(result) {
            const { file, platformMetadata, status, id, thumbnail, activePlatform } = result;
            
            let statusText = '';
            let statusColor = 'text-gray-500';
            let bgColor = 'bg-gray-50';

            if (status === 'complete') {
                statusText = 'Completed'; 
                statusColor = 'text-green-700';
                bgColor = 'bg-green-50';
            } else if (status === 'processing') {
                statusText = 'Processing...'; 
                statusColor = 'text-yellow-700';
                bgColor = 'bg-yellow-50';
            } else if (status === 'pending') {
                statusText = 'Incomplete';
                statusColor = 'text-yellow-700';
                bgColor = 'bg-yellow-50';
            } else if (status === 'error') {
                statusText = 'Error';
                statusColor = 'text-red-700';
                bgColor = 'bg-red-50';
            }
            
            const isExpanded = status === 'processing' || status === 'error' || status === 'complete'; 
            
            const thumbnailHtml = `
                <img src="${thumbnail}" 
                    alt="File thumbnail or icon" 
                    class="preview-thumbnail"
                    onerror="this.onerror=null; this.src='${getFileIcon('generic')}';"
                />
            `;

            // Platform tabs
            const platformTabs = state.selectedPlatforms.map(platform => {
                const isActive = platform === activePlatform;
                const badgeClass = `platform-${platform}`;
                return `
                    <button onclick="switchPlatformTab('${id}', '${platform}')" 
                        class="platform-tab ${isActive ? 'active' : ''} flex-1">
                        <span class="platform-badge ${badgeClass}">${PLATFORM_CONFIGS[platform].name}</span>
                    </button>
                `;
            }).join('');

            // Get active platform metadata
            const activeMetadata = platformMetadata[activePlatform] || { title: '', description: '', keywords: [] };
            const config = PLATFORM_CONFIGS[activePlatform] || PLATFORM_CONFIGS.adobe;
            
            // Check if title meets requirements
            const titleLength = activeMetadata.title.length;
            const isTitleValid = titleLength >= config.titleMin && titleLength <= config.titleMax;
            const charCountClass = isTitleValid ? 'char-success' : 'char-warning';

            return `
                <div id="result-${id}" class="result-item ${bgColor} p-4 rounded-lg border border-200 shadow-sm transition-all duration-300">
                    <div class="flex justify-between items-start cursor-pointer" onclick="toggleResult('${id}')">
                        <div class="flex items-start space-x-4 flex-1 min-w-0">
                            ${thumbnailHtml}
                            <div class="flex-1 min-w-0">
                                <span class="font-bold text-lg text-gray-800 block truncate">${file.name}</span>
                                <span class="text-sm font-semibold ${statusColor} block mt-1">${statusText}</span>
                                ${state.selectedPlatforms.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${state.selectedPlatforms.map(p => `<span class="platform-badge platform-${p} text-xs">${PLATFORM_CONFIGS[p].name}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-500 transform transition-transform flex-shrink-0 ml-2 ${isExpanded ? '' : 'rotate-180'}" id="icon-${id}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <div id="content-${id}" class="mt-4 space-y-4 ${isExpanded ? '' : 'hidden'}">
                        
                        ${state.selectedPlatforms.length > 1 ? `
                            <!-- Platform Tabs -->
                            <div class="flex border-b border-gray-200">
                                ${platformTabs}
                            </div>
                        ` : ''}

                        <!-- Editable Title -->
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500">Title for ${config.name} </label>
                                <span class="edit-indicator">✎ Editable</span>
                            </div>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="title-input-${id}-${activePlatform}" 
                                    value="${activeMetadata.title.replace(/"/g, '&quot;')}"
                                    oninput="updateMetadata('${id}', '${activePlatform}', 'title', this.value)"
                                    class="editable-input w-full text-sm font-medium text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded focus:ring-2 focus:ring-indigo-500"
                                    maxlength="${config.titleMax}"
                                />
                                <button onclick="copyDynamicToClipboard('title-input-${id}-${activePlatform}', this)" class="copy-btn absolute right-0 top-0 h-full px-3 text-gray-600 rounded-r-lg" title="Copy Title">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p id="char-count-${id}-${activePlatform}" class="text-xs mt-1 ${charCountClass}">${titleLength}/${config.titleMax} characters (Required: ${config.titleMin}-${config.titleMax})</p>
                        </div>

                        <!-- Editable Description -->
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500">Description for ${config.name}</label>
                                <span class="edit-indicator">✎ Editable</span>
                            </div>
                            <div class="relative">
                                <textarea 
                                    id="desc-input-${id}-${activePlatform}"
                                    onchange="updateMetadata('${id}', '${activePlatform}', 'description', this.value)"
                                    class="editable-textarea w-full text-sm text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded resize-none focus:ring-2 focus:ring-indigo-500"
                                    rows="2"
                                    maxlength="${config.descMax}"
                                >${activeMetadata.description}</textarea>
                                <button onclick="copyDynamicToClipboard('desc-input-${id}-${activePlatform}', this)" class="copy-btn absolute right-0 top-0 h-10 w-10 text-gray-600 rounded-tr-lg" title="Copy Description">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${activeMetadata.description.length}/${config.descMax} characters</p>
                        </div>

                        <!-- Editable Keywords -->
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-semibold text-gray-500">Keywords for ${config.name} (${activeMetadata.keywords.length}/${config.keywordsMax})</label>
                                <span class="edit-indicator">✎ Editable</span>
                            </div>
                            <div class="relative">
                                <textarea 
                                    id="keywords-input-${id}-${activePlatform}"
                                    onchange="updateMetadata('${id}', '${activePlatform}', 'keywords', this.value)"
                                    class="editable-textarea w-full text-sm text-gray-800 pr-12 px-2 py-1 border border-gray-200 rounded resize-none focus:ring-2 focus:ring-indigo-500"
                                    rows="3"
                                    placeholder="Enter keywords separated by commas"
                                >${activeMetadata.keywords.join(', ')}</textarea>
                                <button onclick="copyDynamicToClipboard('keywords-input-${id}-${activePlatform}', this)" class="copy-btn absolute right-0 top-0 h-10 w-10 text-gray-600 rounded-tr-lg" title="Copy Keywords">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Comma-separated tags</p>
                            
                            <!-- Visual keyword pills display -->
                            ${activeMetadata.keywords.length > 0 ? `
                                <div class="mt-2 pt-2 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-1">Preview:</p>
                                    <div class="text-xs max-h-20 overflow-y-auto">
                                        ${activeMetadata.keywords.map(k => `<span class="keyword-pill">${k}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                    </div>
                </div>
            `;
        }
        
        function renderOutput() {
            elements.resultsCount.textContent = state.files.length;
            elements.resultsContainer.innerHTML = '';
            
            elements.clearBtn.disabled = state.files.length === 0;

            if (state.results.length === 0) {
                elements.initialOutputPlaceholder.classList.remove('hidden');
            } else {
                elements.initialOutputPlaceholder.classList.add('hidden');
                state.results.forEach(result => {
                    elements.resultsContainer.insertAdjacentHTML('beforeend', createResultHtml(result));
                });
            }
            
            updateDownloadButtons();
        }

        window.copyDynamicToClipboard = function(elementId, button) {
            const element = document.getElementById(elementId);
            const textToCopy = element.value || element.textContent;
            
            copyTextLogic(textToCopy, button);
        }

        window.copyRawTextToClipboard = function(textToCopy, button) {
            copyTextLogic(textToCopy, button);
        }

        function copyTextLogic(textToCopy, button) {
             if (!textToCopy) {
                showStatus(`Field is empty.`, 'error');
                return;
            }
            
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = textToCopy;
            tempTextarea.style.position = 'fixed'; 
            tempTextarea.style.opacity = '0';
            document.body.appendChild(tempTextarea);
            
            tempTextarea.select();
            tempTextarea.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showStatus(`Copied to clipboard!`, 'success');
                
                button.innerHTML = `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                setTimeout(() => {
                    button.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3"></path></svg>`;
                }, 1500);

            } catch (err) {
                console.error('Copy failed:', err);
                showStatus('Copy failed. Please manually select and copy.', 'error');
            } finally {
                document.body.removeChild(tempTextarea);
            }
        }


        function showStatus(message, type) {
            elements.statusMessage.textContent = message;
            elements.statusMessage.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-gray-800', 'bg-green-600');
            elements.statusMessage.classList.add('opacity-100');
            
            if (type === 'success') {
                elements.statusMessage.classList.add('bg-green-600');
            } else if (type === 'error') {
                elements.statusMessage.classList.add('bg-red-500');
            } else {
                elements.statusMessage.classList.add('bg-gray-800');
            }

            setTimeout(() => {
                elements.statusMessage.classList.remove('opacity-100');
                elements.statusMessage.classList.add('opacity-0');
                setTimeout(() => {
                    elements.statusMessage.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderOutput();
            updatePlatformSelection(); // Initialize platform state
        });
    </script>
</body>
</html>
